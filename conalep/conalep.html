<!DOCTYPE html>
<html lang="es-MX">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CONALEP | Panel de Calificaciones</title>
  <meta name="theme-color" content="#0a7d5d">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --c-green:#0a7d5d; /* verde CONALEP aproximado */
      --c-green-700:#08644b;
      --c-green-100:#e6f3ef;
      --c-gray-50:#f7f7f8; --c-gray-100:#f1f2f4; --c-gray-200:#e4e6eb;
      --c-gray-300:#d0d3d9; --c-gray-600:#6b7280; --c-gray-800:#1f2937; --c-white:#fff;
      --radius:14px; --shadow:0 10px 18px rgba(16,24,40,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:var(--c-gray-800); background:linear-gradient(180deg,#fbfbfb, #f2f6f5 420px);}  
    .app{display:grid; grid-template-columns:280px 1fr; min-height:100vh}
    aside{background:var(--c-white); border-right:1px solid var(--c-gray-200); padding:24px; position:sticky; top:0; height:100vh}
    .brand{display:flex; align-items:center; gap:12px; margin-bottom:24px}
    .brand img.logo{width:40px; height:40px; object-fit:cover; border-radius:6px}
    .nav a{display:flex; align-items:center; gap:10px; text-decoration:none; color:#0b3d2f; padding:10px 12px; border-radius:10px; font-weight:600}
    .nav a:hover, .nav a.active{background:var(--c-green-100); color:var(--c-green)}
    header{display:flex; align-items:center; justify-content:space-between; padding:18px 26px; position:sticky; top:0; z-index:5; backdrop-filter:saturate(160%) blur(6px); background:rgba(255,255,255,.8); border-bottom:1px solid var(--c-gray-200)}
    header .filters{display:flex; flex-wrap:wrap; gap:12px}
    .select, .input, .button{border:1px solid var(--c-gray-300); background:#fff; padding:10px 12px; border-radius:10px; font:inherit}
    .button{cursor:pointer; border-color:transparent; background:var(--c-green); color:#fff; box-shadow:var(--shadow)}
    .button.gray{background:#fff; color:#111; border:1px solid var(--c-gray-300)}
    .button.warn{background:#9b1c1c}
    .button:disabled{opacity:.6; cursor:not-allowed}
    main{padding:20px 26px; max-width:1400px; margin:0 auto}
    .grid{display:grid; gap:16px}
    .grid.cols-4{grid-template-columns:repeat(4, 1fr)}
    .card{background:#fff; border:1px solid var(--c-gray-200); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px}
    .stat h3{margin:6px 0 2px; font-size:28px}
    .stat p{margin:0; color:var(--c-gray-600)}
    .toolbar{display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between; margin:10px 0 12px}
    .toolbar .left,.toolbar .right{display:flex; gap:8px; align-items:center}
    .table-wrap{overflow:auto; border-radius:var(--radius); border:1px solid var(--c-gray-200); background:#fff}
    table{width:100%; border-collapse:separate; border-spacing:0; min-width:980px}
    thead th{position:sticky; top:0; z-index:2; background:#f7faf9; text-align:left; font-size:13px; color:#0b3d2f; border-bottom:1px solid var(--c-gray-200); padding:10px 12px}
    tbody td{border-bottom:1px solid var(--c-gray-100); padding:8px 12px; vertical-align:middle}
    tbody tr:hover{background:#fcfefe}
    .num{font-variant-numeric:tabular-nums; text-align:center}
    .tag{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:9999px; font-size:12px; font-weight:700}
    .tag.ok{background:#e8faf2; color:#0a7d5d}
    .tag.bad{background:#fff1f1; color:#9b1c1c}
    .muted{color:var(--c-gray-600)}
    .editable{width:70px}
    input[type="number"]{width:80px; padding:8px 10px; border:1px solid var(--c-gray-300); border-radius:8px; font:inherit; text-align:center}
    input[type="text"].cell{width:100%; padding:8px 10px; border:1px solid var(--c-gray-300); border-radius:8px}
    .note{font-size:12px; color:var(--c-gray-600)}
    /* Modales */
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(16,24,40,.45); z-index:30}
    .modal.open{display:flex}
    .modal .box{background:#fff; width:min(720px, 96vw); border-radius:16px; border:1px solid var(--c-gray-200); box-shadow:var(--shadow); padding:18px}
    .modal .box h3{margin:4px 0 12px}
    .modal .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .modal label{font-size:13px; color:#334155}
    .modal input, .modal select{width:100%; padding:10px 12px; border:1px solid var(--c-gray-300); border-radius:10px; font:inherit}
    /* Historial */
    .history-wrap{margin-top:26px}
    .history-table{min-width:1100px}
    /* Print */
    @media print{
      aside, header, .toolbar, .note, .stat, .actions, .no-print, .history-wrap{display:none !important}
      main{padding:0}
      .table-wrap{border:none}
      thead th{background:#fff}
      body{background:#fff}
    }
    @media (max-width: 980px){
      .app{grid-template-columns:1fr}
      aside{position:static; height:auto}
      .grid.cols-4{grid-template-columns:1fr 1fr}
      thead th:first-child, tbody td:first-child{position:sticky; left:0; background:#fff; border-right:1px solid var(--c-gray-100)}
    }
  </style>
</head>
<body>
  <div class="app">
    <aside>
      <div class="brand">
        <img class="logo" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRNrFCIykyssKXfyEFoM-hXxZB0WQl3JO4gLQ&s" alt="CONALEP Logo"/>
        <div>
          <div style="font-weight:800; letter-spacing:.2px">CONALEP</div>
          <div class="muted" style="font-size:12px">Panel de Calificaciones</div>
        </div>
      </div>
      <nav class="nav">
        <a class="active" href="#"><span>üè†</span> Dashboard</a>
        <a href="#" id="nav-cargar"><span>üì•</span> Cargar CSV</a>
        <a href="#" id="nav-alumnos"><span>üë•</span> Alumnos</a>
        <a href="#" id="nav-calif"><span>üìù</span> Calificaciones</a>
        <a href="#historial" id="nav-hist"><span>üïì</span> Historial</a>
        <a href="#" id="nav-config"><span>‚öôÔ∏è</span> Configuraci√≥n</a>
      </nav>
      <div style="margin-top:auto; padding-top:24px">
        <div class="note">Los cambios se guardan en tu navegador (LocalStorage). Para uso real, conecta tu backend (por ejemplo, Firebase/Firestore o tu API).</div>
      </div>
    </aside>

    <section>
      <header class="no-print">
        <div class="filters">
          <select class="select" id="periodo">
            <option value="2025-A">Periodo 2025-A</option>
            <option value="2025-B">Periodo 2025-B</option>
            <option value="2024-B">Periodo 2024-B</option>
          </select>
          <select class="select" id="carrera">
            <option>T√©cnico Bachiller en Inform√°tica</option>
            <option>Mecatr√≥nica</option>
            <option>Electromec√°nica</option>
            <option>Contabilidad</option>
          </select>
          <select class="select" id="modulo">
            <option value="Programaci√≥n I">M√≥dulo: Programaci√≥n I</option>
            <option value="Matem√°ticas II">M√≥dulo: Matem√°ticas II</option>
            <option value="Comunicaci√≥n">M√≥dulo: Comunicaci√≥n</option>
          </select>
          <select class="select" id="grupo">
            <option value="1A">Grupo 1A</option>
            <option value="1B">Grupo 1B</option>
            <option value="2A">Grupo 2A</option>
          </select>
        </div>
        <div class="filters">
          <input class="input" id="buscador" placeholder="Buscar alumno por nombre o matr√≠cula"/>
          <button class="button gray" id="imprimir">Imprimir acta</button>
          <button class="button" id="btnGuardar">Guardar cambios</button>
        </div>
      </header>

      <main>
        <div class="grid cols-4">
          <div class="card stat">
            <p>Alumnos</p>
            <h3 id="stat-alumnos">0</h3>
          </div>
          <div class="card stat">
            <p>Promedio general</p>
            <h3 id="stat-prom">0</h3>
          </div>
          <div class="card stat">
            <p>Aprobados</p>
            <h3 id="stat-ok">0</h3>
          </div>
          <div class="card stat">
            <p>Reprobados</p>
            <h3 id="stat-bad">0</h3>
          </div>
        </div>

        <div class="toolbar">
          <div class="left">
            <button class="button" id="btnNuevo">Nuevo alumno</button>
            <button class="button" id="btnCargar">Cargar CSV</button>
            <button class="button gray" id="btnExportar">Exportar CSV</button>
          </div>
          <div class="right">
            <span class="note">F√≥rmula final: promedio de Parcial 1‚Äì3. Extraordinario sustituye si es mayor.</span>
          </div>
        </div>

        <div class="table-wrap" id="tablaWrap">
          <table id="tabla">
            <thead>
              <tr>
                <th style="min-width:120px">Matr√≠cula</th>
                <th style="min-width:180px">Ap. Paterno</th>
                <th style="min-width:180px">Ap. Materno</th>
                <th style="min-width:220px">Nombres</th>
                <th class="num">Parcial 1 <button class="button gray no-print" data-bulk="p1" style="padding:4px 8px; font-size:12px">‚áß</button></th>
                <th class="num">Parcial 2 <button class="button gray no-print" data-bulk="p2" style="padding:4px 8px; font-size:12px">‚áß</button></th>
                <th class="num">Parcial 3 <button class="button gray no-print" data-bulk="p3" style="padding:4px 8px; font-size:12px">‚áß</button></th>
                <th class="num">Extraordinario <button class="button gray no-print" data-bulk="ext" style="padding:4px 8px; font-size:12px">‚áß</button></th>
                <th class="num">Final</th>
                <th class="num">Estado</th>
                <th class="no-print">Acciones</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <p class="note" style="margin-top:10px">Consejo: da clic en ‚áß para asignar el mismo puntaje a toda la columna o vaciarla.</p>

        <!-- ===== Historial de cambios ===== -->
        <div class="history-wrap" id="historial">
          <div class="toolbar">
            <div class="left">
              <h3 style="margin:0">Historial de cambios</h3>
            </div>
            <div class="right">
              <button class="button gray" id="btnSeedDemo">Restaurar demo</button>
              <button class="button gray" id="btnExportHist">Exportar historial CSV</button>
              <button class="button warn" id="btnClearHist">Borrar historial</button>
            </div>
          </div>
          <div class="table-wrap">
            <table class="history-table">
              <thead>
                <tr>
                  <th style="min-width:160px">Fecha</th>
                  <th>Acci√≥n</th>
                  <th style="min-width:220px">Alumno</th>
                  <th>Campo</th>
                  <th>Antes</th>
                  <th>Despu√©s</th>
                  <th>Usuario</th>
                </tr>
              </thead>
              <tbody id="tbodyHist"></tbody>
            </table>
          </div>
        </div>

        <input id="fileCsv" type="file" accept=".csv" hidden>
      </main>
    </section>
  </div>

  <!-- Modal: Nuevo alumno -->
  <div class="modal" id="modalNuevo">
    <div class="box">
      <h3>Agregar alumno</h3>
      <div class="row">
        <div>
          <label>Matr√≠cula</label>
          <input id="m_matricula" placeholder="Ej. 24-12345"/>
        </div>
        <div>
          <label>Apellido paterno</label>
          <input id="m_apepat"/>
        </div>
        <div>
          <label>Apellido materno</label>
          <input id="m_apemat"/>
        </div>
        <div>
          <label>Nombres</label>
          <input id="m_nombres"/>
        </div>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px">
        <button class="button gray" data-close="#modalNuevo">Cancelar</button>
        <button class="button" id="m_guardar">Agregar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Configuraci√≥n -->
  <div class="modal" id="modalConfig">
    <div class="box">
      <h3>Configuraci√≥n de c√°lculo</h3>
      <div class="row">
        <div>
          <label>Calificaci√≥n m√≠nima aprobatoria</label>
          <input id="cfg_min" type="number" min="0" max="100" step="1" value="70"/>
        </div>
        <div>
          <label>Redondear final</label>
          <select id="cfg_round">
            <option value="nearest">Al m√°s cercano</option>
            <option value="down">Hacia abajo</option>
            <option value="up">Hacia arriba</option>
            <option value="none">Sin redondeo</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label>Peso Parcial 1 (0‚Äì1)</label>
          <input id="cfg_w1" type="number" min="0" max="1" step="0.01" value="0.33"/>
        </div>
        <div>
          <label>Peso Parcial 2 (0‚Äì1)</label>
          <input id="cfg_w2" type="number" min="0" max="1" step="0.01" value="0.33"/>
        </div>
        <div>
          <label>Peso Parcial 3 (0‚Äì1)</label>
          <input id="cfg_w3" type="number" min="0" max="1" step="0.01" value="0.34"/>
        </div>
        <div>
          <label>Extraordinario sustituye si &gt; Final</label>
          <select id="cfg_ext_over">
            <option value="true">S√≠</option>
            <option value="false">No</option>
          </select>
        </div>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px">
        <button class="button gray" data-close="#modalConfig">Cancelar</button>
        <button class="button" id="cfg_guardar">Guardar</button>
      </div>
    </div>
  </div>

  <script>
    // ====== Estado global ======
    const state = {
      alumnos: [],
      historial: [],
      cfg: { minAprob: 70, round: 'nearest', w1: 0.33, w2: 0.33, w3: 0.34, extOverrides: true }
    };

    // ====== Datos demo ======
    const demoAlumnos = [
      {id: uid(), matricula:'25-00123', apepat:'Hern√°ndez', apemat:'L√≥pez', nombres:'Mar√≠a Fernanda', p1:85, p2:78, p3:92, ext:''},
      {id: uid(), matricula:'25-00124', apepat:'Garc√≠a', apemat:'Ram√≠rez', nombres:'Juan Carlos', p1:60, p2:65, p3:58, ext:75},
      {id: uid(), matricula:'25-00125', apepat:'Santos', apemat:'P√©rez', nombres:'Ximena', p1:90, p2:88, p3:94, ext:''},
      {id: uid(), matricula:'25-00126', apepat:'Luna', apemat:'Castillo', nombres:'Diego Armando', p1:70, p2:72, p3:68, ext:''},
      {id: uid(), matricula:'25-00127', apepat:'Mart√≠nez', apemat:'Vega', nombres:'Ana Sof√≠a', p1:55, p2:62, p3:59, ext:70},
      {id: uid(), matricula:'25-00128', apepat:'Flores', apemat:'Mendoza', nombres:'Luis √Ångel', p1:88, p2:91, p3:86, ext:''},
      {id: uid(), matricula:'25-00129', apepat:'Reyes', apemat:'Cruz', nombres:'Camila', p1:74, p2:77, p3:80, ext:''},
      {id: uid(), matricula:'25-00130', apepat:'Dom√≠nguez', apemat:'Navarro', nombres:'Emiliano', p1:40, p2:55, p3:58, ext:72},
      {id: uid(), matricula:'25-00131', apepat:'Ortiz', apemat:'Aguilar', nombres:'Valeria', p1:95, p2:93, p3:97, ext:''},
      {id: uid(), matricula:'25-00132', apepat:'Casta√±eda', apemat:'Ibarra', nombres:'Sebasti√°n', p1:68, p2:64, p3:70, ext:''},
      {id: uid(), matricula:'25-00133', apepat:'Pacheco', apemat:'Salazar', nombres:'Paulina', p1:82, p2:79, p3:84, ext:''},
      {id: uid(), matricula:'25-00134', apepat:'Rojas', apemat:'Ju√°rez', nombres:'Iv√°n', p1:61, p2:58, p3:63, ext:69}
    ];

    const demoHistorial = [
      {id: uid(), ts: Date.now()-86400000*4,   usuario:'admin',     accion:'Carga CSV',         alumno:'12 filas', campo:'‚Äî', antes:'‚Äî', despues:'Importados'},
      {id: uid(), ts: Date.now()-86400000*3.9, usuario:'admin',     accion:'Edici√≥n de nota',   alumno:'25-00127 ¬∑ Mart√≠nez Vega, Ana Sof√≠a', campo:'P2',  antes:58, despues:62},
      {id: uid(), ts: Date.now()-86400000*3.8, usuario:'admin',     accion:'Edici√≥n de nota',   alumno:'25-00127 ¬∑ Mart√≠nez Vega, Ana Sof√≠a', campo:'EXT', antes:'‚Äî', despues:70},
      {id: uid(), ts: Date.now()-86400000*3.7, usuario:'prof_prog', accion:'Edici√≥n de nota',   alumno:'25-00130 ¬∑ Dom√≠nguez Navarro, Emiliano', campo:'P3',  antes:52, despues:58},
      {id: uid(), ts: Date.now()-86400000*3.6, usuario:'prof_prog', accion:'Edici√≥n de nota',   alumno:'25-00130 ¬∑ Dom√≠nguez Navarro, Emiliano', campo:'EXT', antes:'‚Äî', despues:72},
      {id: uid(), ts: Date.now()-86400000*3.5, usuario:'admin',     accion:'Edici√≥n de nota',   alumno:'25-00124 ¬∑ Garc√≠a Ram√≠rez, Juan Carlos', campo:'P3',  antes:58, despues:75},
      {id: uid(), ts: Date.now()-86400000*3.4, usuario:'admin',     accion:'Edici√≥n de datos',  alumno:'25-00124 ¬∑ Garc√≠a Ram√≠rez, Juan Carlos', campo:'Ap. Paterno', antes:'Garcia', despues:'Garc√≠a'},
      {id: uid(), ts: Date.now()-86400000*3.3, usuario:'prof_prog', accion:'Edici√≥n de nota',   alumno:'25-00129 ¬∑ Reyes Cruz, Camila', campo:'P2',  antes:72, despues:77},
      {id: uid(), ts: Date.now()-86400000*2.2, usuario:'prof_prog', accion:'Edici√≥n de nota',   alumno:'25-00131 ¬∑ Ortiz Aguilar, Valeria', campo:'P1',  antes:92, despues:95},
      {id: uid(), ts: Date.now()-86400000*2.1, usuario:'admin',     accion:'Asignaci√≥n masiva', alumno:'Todos', campo:'P1', antes:'(varios)', despues:'Revisi√≥n general'},
      {id: uid(), ts: Date.now()-86400000*1.5, usuario:'admin',     accion:'Eliminaci√≥n',       alumno:'25-00099 ¬∑ Torres N√∫√±ez, Daniel', campo:'Fila', antes:'Exist√≠a', despues:'Eliminada'},
      {id: uid(), ts: Date.now()-3600*1000*8, usuario:'prof_prog',  accion:'Edici√≥n de nota',   alumno:'25-00134 ¬∑ Rojas Ju√°rez, Iv√°n', campo:'EXT', antes:'‚Äî', despues:69},
      {id: uid(), ts: Date.now()-3600*1000*6, usuario:'prof_prog',  accion:'Edici√≥n de nota',   alumno:'25-00132 ¬∑ Casta√±eda Ibarra, Sebasti√°n', campo:'P3', antes:66, despues:70},
      {id: uid(), ts: Date.now()-3600*1000*2, usuario:'admin',      accion:'Configuraci√≥n',     alumno:'‚Äî', campo:'Pesos/Reglas', antes:'{"minAprob":70,"round":"nearest","w1":0.33,"w2":0.33,"w3":0.34,"extOverrides":true}', despues:'{"minAprob":70,"round":"nearest","w1":0.33,"w2":0.33,"w3":0.34,"extOverrides":true}'}
    ];

    // ====== Utilidades ======
    function uid(){return Math.random().toString(36).slice(2,9)}
    const $ = sel => document.querySelector(sel);
    function clamp(n,min,max){return Math.min(Math.max(n, min), max)}
    function parseGrade(v){ if(v===''||v==null) return ''; const n=Number(v); return Number.isNaN(n)?'':clamp(Math.round(n),0,100); }
    function roundBy(mode,v){ if(mode==='none') return v; if(mode==='up') return Math.ceil(v); if(mode==='down') return Math.floor(v); return Math.round(v); }
    function fmtDate(ts){ return new Date(ts).toLocaleString('es-MX',{dateStyle:'short',timeStyle:'short'}); }

    function key(){ const p=$('#periodo').value, c=$('#carrera').value, m=$('#modulo').value, g=$('#grupo').value; return `conalep:${p}:${c}:${m}:${g}` }
    function save(){ localStorage.setItem(key(), JSON.stringify({alumnos:state.alumnos, cfg:state.cfg, historial:state.historial})); flash('Cambios guardados'); }
    function load(){
      const raw = localStorage.getItem(key());
      if(raw){
        try{ const data = JSON.parse(raw);
          state.alumnos   = Array.isArray(data.alumnos) ? data.alumnos : [];
          state.historial = Array.isArray(data.historial) ? data.historial : [];
          Object.assign(state.cfg, data.cfg||{});
        }catch(e){ console.warn(e); }
      }
      // Si no hay datos guardados, sembrar demo para que SIEMPRE se vea algo.
      if(!state.alumnos.length){ state.alumnos = demoAlumnos.map(x=>({...x})); }
      if(!state.historial.length){ state.historial = demoHistorial.map(x=>({...x})); }
    }
    function flash(msg){ const el=document.createElement('div'); el.textContent=msg; Object.assign(el.style,{position:'fixed',right:'16px',bottom:'16px',padding:'10px 14px',background:'var(--c-green)',color:'#fff',borderRadius:'10px',boxShadow:'var(--shadow)',zIndex:99}); document.body.appendChild(el); setTimeout(()=>el.remove(),1600); }

    // ====== C√°lculo de final ======
    function calcFinal(a){
      const {w1,w2,w3, round, extOverrides, minAprob} = state.cfg;
      const p1=Number(a.p1||0), p2=Number(a.p2||0), p3=Number(a.p3||0);
      let fin=(p1*w1)+(p2*w2)+(p3*w3);
      if(extOverrides && a.ext!=='' && !Number.isNaN(Number(a.ext))) fin=Math.max(fin, Number(a.ext));
      fin = roundBy(round, fin);
      const estado = fin>=minAprob? 'Aprobado':'Reprobado';
      return {final:fin, estado};
    }

    // ====== Render ======
    function render(){
      const q = ($('#buscador').value||'').toLowerCase();
      const tbody = $('#tbody'); tbody.innerHTML='';
      let sum=0, aprob=0, reprob=0;
      state.alumnos.filter(a=>`${a.matricula} ${a.apepat} ${a.apemat} ${a.nombres}`.toLowerCase().includes(q))
        .forEach(a=>{
          const {final, estado} = calcFinal(a); sum+=final; if(estado==='Aprobado') aprob++; else reprob++;
          const tr=document.createElement('tr');
          tr.innerHTML=`
            <td><input class="cell" data-field="matricula" value="${escapeHtml(a.matricula)}"/></td>
            <td><input class="cell" data-field="apepat" value="${escapeHtml(a.apepat)}"/></td>
            <td><input class="cell" data-field="apemat" value="${escapeHtml(a.apemat)}"/></td>
            <td><input class="cell" data-field="nombres" value="${escapeHtml(a.nombres)}"/></td>
            <td class="num"><input class="editable" type="number" min="0" max="100" step="1" data-field="p1" value="${a.p1!==''?a.p1:''}"/></td>
            <td class="num"><input class="editable" type="number" min="0" max="100" step="1" data-field="p2" value="${a.p2!==''?a.p2:''}"/></td>
            <td class="num"><input class="editable" type="number" min="0" max="100" step="1" data-field="p3" value="${a.p3!==''?a.p3:''}"/></td>
            <td class="num"><input class="editable" type="number" min="0" max="100" step="1" data-field="ext" value="${a.ext!==''?a.ext:''}"/></td>
            <td class="num">${final}</td>
            <td class="num">${estado==='Aprobado'?'<span class="tag ok">Aprobado</span>':'<span class="tag bad">Reprobado</span>'}</td>
            <td class="actions no-print"><button class="button gray" data-del="${a.id}">Eliminar</button></td>`;
          tr.dataset.id=a.id; tbody.appendChild(tr);
        });
      // Stats
      $('#stat-alumnos').textContent = state.alumnos.length;
      $('#stat-prom').textContent = state.alumnos.length? Math.round(sum/state.alumnos.length):0;
      $('#stat-ok').textContent = aprob; $('#stat-bad').textContent = reprob;

      // Bind inputs (con logging)
      tbody.querySelectorAll('input').forEach(inp=>{
        inp.addEventListener('focus', e=>{ e.target.dataset.prev = e.target.value; });
        inp.addEventListener('input', e=>{
          const id=e.target.closest('tr').dataset.id; const field=e.target.dataset.field; const a=state.alumnos.find(x=>x.id===id); if(!a) return;
          let newVal; if(['p1','p2','p3','ext'].includes(field)){ newVal=e.target.value===''?'':parseGrade(e.target.value); a[field]=newVal; } else { newVal=e.target.value; a[field]=newVal; }
          const prev=e.target.dataset.prev??''; if(String(prev)!==String(newVal)){
            logCambio({usuario:'admin', accion:['p1','p2','p3','ext'].includes(field)?'Edici√≥n de nota':'Edici√≥n de datos', alumno:`${a.matricula} ¬∑ ${a.apepat} ${a.apemat}, ${a.nombres}`, campo:field.toUpperCase(), antes: prev===''?'‚Äî':prev, despues: newVal===''?'‚Äî':newVal});
            e.target.dataset.prev=newVal;
          }
          render();
        });
      });

      // Delete
      tbody.querySelectorAll('[data-del]').forEach(btn=> btn.addEventListener('click', e=>{
        const id=e.currentTarget.getAttribute('data-del'); const a=state.alumnos.find(x=>x.id===id); if(!a) return;
        if(confirm(`Eliminar a ${a.nombres}?`)){
          state.alumnos = state.alumnos.filter(x=>x.id!==id);
          logCambio({usuario:'admin', accion:'Eliminaci√≥n', alumno:`${a.matricula} ¬∑ ${a.apepat} ${a.apemat}, ${a.nombres}`, campo:'Fila', antes:'Exist√≠a', despues:'Eliminada'});
          render();
        }
      }));

      renderHistorial();
    }

    function escapeHtml(s=''){ return s.replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[c])); }

    // ====== CSV ======
    function parseCSV(text){ const rows=[]; let i=0, field='', inQ=false, row=[]; while(i<text.length){ const ch=text[i]; if(ch==='"'){ if(inQ && text[i+1]==='"'){ field+='"'; i++; } else inQ=!inQ; } else if(ch===','&&!inQ){ row.push(field); field=''; } else if((ch==='\n'||ch==='\r')&&!inQ){ if(field!==''||row.length){ row.push(field); rows.push(row); row=[]; field=''; } } else { field+=ch } i++; } if(field!==''||row.length){ row.push(field); rows.push(row) } return rows.filter(r=>r.some(c=>c.trim()!=='')); }
    function mapCsvToAlumnos(rows){ const header=rows[0].map(h=>h.trim().toLowerCase()); const body=header.some(h=>['matricula','matr√≠cula','apellidopaterno','apepat','apellido paterno'].includes(h))?rows.slice(1):rows; const idx=name=> header.findIndex(h=> h.replace(/\s+/g,'')===name.replace(/\s+/g,'').toLowerCase()); const iMat=Math.max(idx('matricula'),idx('matr√≠cula')); const iPat=Math.max(idx('apellidopaterno'),idx('apepat'),idx('apellido paterno')); const iMat2=Math.max(idx('apellidomaterno'),idx('apemat'),idx('apellido materno')); const iNom=Math.max(idx('nombres'),idx('nombre')); const iP1=Math.max(idx('parcial1'),idx('p1')); const iP2=Math.max(idx('parcial2'),idx('p2')); const iP3=Math.max(idx('parcial3'),idx('p3')); const iExt=Math.max(idx('extraordinario'),idx('ext'));
      const alumnos=body.map(r=>({ id:uid(), matricula:get(r,iMat), apepat:get(r,iPat), apemat:get(r,iMat2), nombres:get(r,iNom), p1:toNum(get(r,iP1)), p2:toNum(get(r,iP2)), p3:toNum(get(r,iP3)), ext:toNum(get(r,iExt)) }));
      if(alumnos.length){ logCambio({usuario:'admin', accion:'Carga CSV', alumno:`${alumnos.length} alumno(s)`, campo:'‚Äî', antes:'‚Äî', despues:'Importados'}); }
      return alumnos.filter(a=>a.matricula||a.nombres); function get(r,i){ return i>=0?(r[i]||'').trim():'' } function toNum(v){ return v===''?'':parseGrade(v) }
    }
    function toCSV(){ const cols=['Matricula','ApellidoPaterno','ApellidoMaterno','Nombres','Parcial1','Parcial2','Parcial3','Extraordinario','Final','Estado']; const lines=[cols.join(',')]; state.alumnos.forEach(a=>{ const {final,estado}=calcFinal(a); const row=[a.matricula,a.apepat,a.apemat,a.nombres,a.p1,a.p2,a.p3,a.ext,final,estado].map(v=> v===undefined?'':String(v).includes(',')?`"${String(v).replace(/"/g,'""')}"`:v); lines.push(row.join(',')); }); return lines.join('\n'); }
    function historyToCSV(){ const cols=['Fecha','Accion','Alumno','Campo','Antes','Despues','Usuario']; const lines=[cols.join(',')]; state.historial.forEach(h=>{ const row=[fmtDate(h.ts),h.accion,h.alumno,h.campo,h.antes,h.despues,h.usuario].map(v=> v===undefined?'':String(v).includes(',')?`"${String(v).replace(/"/g,'""')}"`:v); lines.push(row.join(',')); }); return lines.join('\n'); }

    // ====== Historial ======
    function logCambio({usuario,accion,alumno,campo,antes,despues}){ state.historial.unshift({id:uid(), ts:Date.now(), usuario, accion, alumno, campo, antes, despues}); renderHistorial(); save(); }
    function renderHistorial(){ const tbody=$('#tbodyHist'); if(!tbody) return; tbody.innerHTML=''; if(!state.historial.length){ const tr=document.createElement('tr'); tr.innerHTML=`<td colspan="7" style="text-align:center; color:var(--c-gray-600)">Sin movimientos</td>`; tbody.appendChild(tr); return; } state.historial.slice(0,300).forEach(h=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${fmtDate(h.ts)}</td><td>${escapeHtml(h.accion)}</td><td>${escapeHtml(h.alumno)}</td><td>${escapeHtml(h.campo)}</td><td>${escapeHtml(String(h.antes))}</td><td>${escapeHtml(String(h.despues))}</td><td>${escapeHtml(h.usuario)}</td>`; tbody.appendChild(tr); }); }

    // ====== UI ======
    function bindUI(){
      $('#btnNuevo').addEventListener('click', ()=> openModal('#modalNuevo'));
      $('#nav-config').addEventListener('click', ()=> openModal('#modalConfig'));
      $('#btnCargar').addEventListener('click', ()=> $('#fileCsv').click());
      $('#nav-cargar').addEventListener('click', ()=> $('#fileCsv').click());
      $('#fileCsv').addEventListener('change', onCsvSelected);
      $('#btnExportar').addEventListener('click', ()=>{ const blob=new Blob([toCSV()],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`calificaciones_${key().replace(/[:\s]/g,'_')}.csv`; a.click(); URL.revokeObjectURL(url); });
      $('#btnGuardar').addEventListener('click', save);
      $('#imprimir').addEventListener('click', ()=> window.print());
      $('#buscador').addEventListener('input', render);

      document.querySelectorAll('[data-bulk]').forEach(btn=> btn.addEventListener('click', ()=>{ const map={p1:'p1',p2:'p2',p3:'p3',ext:'ext'}; bulkPrompt(map[btn.dataset.bulk]); }));

      ['periodo','carrera','modulo','grupo'].forEach(id=> $('#'+id).addEventListener('change', ()=>{ load(); render(); }));

      // Modal Nuevo
      $('#m_guardar').addEventListener('click', ()=>{ const alumno={ id:uid(), matricula:$('#m_matricula').value.trim(), apepat:$('#m_apepat').value.trim(), apemat:$('#m_apemat').value.trim(), nombres:$('#m_nombres').value.trim(), p1:'',p2:'',p3:'',ext:'' }; if(!alumno.matricula||!alumno.nombres){ alert('Matr√≠cula y nombres son obligatorios'); return; } state.alumnos.push(alumno); logCambio({usuario:'admin', accion:'Alta', alumno:`${alumno.matricula} ¬∑ ${alumno.apepat} ${alumno.apemat}, ${alumno.nombres}`, campo:'Fila', antes:'‚Äî', despues:'Creada'}); closeModal('#modalNuevo'); render(); });

      // Modal Config
      $('#cfg_guardar').addEventListener('click', ()=>{ const totalW=Number($('#cfg_w1').value)+Number($('#cfg_w2').value)+Number($('#cfg_w3').value); if(Math.abs(totalW-1)>0.001){ alert('La suma de pesos debe ser 1.0'); return; } const prev={...state.cfg}; state.cfg.minAprob=parseGrade($('#cfg_min').value); state.cfg.round=$('#cfg_round').value; state.cfg.w1=Number($('#cfg_w1').value); state.cfg.w2=Number($('#cfg_w2').value); state.cfg.w3=Number($('#cfg_w3').value); state.cfg.extOverrides=$('#cfg_ext_over').value==='true'; closeModal('#modalConfig'); render(); logCambio({usuario:'admin', accion:'Configuraci√≥n', alumno:'‚Äî', campo:'Pesos/Reglas', antes: JSON.stringify(prev), despues: JSON.stringify(state.cfg)}); });

      // Historial acciones
      $('#btnSeedDemo').addEventListener('click', ()=>{ if(confirm('¬øRestaurar datos de demostraci√≥n para este grupo? Esto reemplazar√° alumnos e historial actuales.')){ state.alumnos=demoAlumnos.map(x=>({...x})); state.historial=demoHistorial.map(x=>({...x})); save(); render(); flash('Datos demo restaurados'); } });
      $('#btnExportHist').addEventListener('click', ()=>{ const blob=new Blob([historyToCSV()],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`historial_${key().replace(/[:\s]/g,'_')}.csv`; a.click(); URL.revokeObjectURL(url); });
      $('#btnClearHist').addEventListener('click', ()=>{ if(confirm('¬øBorrar todo el historial de este grupo?')){ state.historial=[]; renderHistorial(); save(); } });

      // Cerrar modales
      document.querySelectorAll('[data-close]').forEach(btn=> btn.addEventListener('click', ()=> closeModal(btn.getAttribute('data-close'))));
      document.querySelectorAll('.modal').forEach(m=> m.addEventListener('click', e=>{ if(e.target===m) closeModal('#'+m.id); }));
    }

    function onCsvSelected(e){ const f=e.target.files[0]; if(!f) return; const reader=new FileReader(); reader.onload=()=>{ const rows=parseCSV(reader.result); const alumnos=mapCsvToAlumnos(rows); if(!alumnos.length){ alert('No se detectaron filas v√°lidas. Revisa el CSV.'); return; } if(confirm(`Se cargar√°n ${alumnos.length} alumnos. Esto reemplazar√° a los existentes en este grupo. ¬øContinuar?`)){ state.alumnos=alumnos; render(); } }; reader.readAsText(f,'utf-8'); e.target.value=''; }

    // ====== Bulk ======
    function bulkPrompt(field){ const action=prompt('Escribe un n√∫mero 0-100 para asignar a toda la columna, o deja vac√≠o para vaciarla.'); if(action===null) return; const v=action.trim()===''?'':parseGrade(action); state.alumnos.forEach(a=> a[field]=v); logCambio({usuario:'admin', accion:'Asignaci√≥n masiva', alumno:'Todos', campo:field.toUpperCase(), antes:'(varios)', despues: v===''?'vac√≠o':v}); render(); }

    // ====== Modales ======
    function openModal(sel){ document.querySelector(sel).classList.add('open') }
    function closeModal(sel){ document.querySelector(sel).classList.remove('open') }

    // ====== Inicio ======
    load();
    bindUI();
    render();
  </script>
</body>
</html>
