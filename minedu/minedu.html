<!DOCTYPE html>
<html lang="es-PE">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MINEDU | Panel de Calificaciones</title>
  <meta name="theme-color" content="#c62828">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --c-red:#c62828;          /* rojo MINEDU aproximado */
      --c-red-700:#b71c1c;
      --c-red-100:#fdeaea;
      --c-gray-50:#f7f7f8; --c-gray-100:#f1f2f4; --c-gray-200:#e4e6eb;
      --c-gray-300:#d0d3d9; --c-gray-600:#6b7280; --c-gray-800:#1f2937; --c-white:#fff;
      --radius:14px; --shadow:0 10px 18px rgba(16,24,40,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:var(--c-gray-800); background:linear-gradient(180deg,#fbfbfb, #f6f3f3 420px);}  
    .app{display:grid; grid-template-columns:300px 1fr; min-height:100vh}
    aside{background:var(--c-white); border-right:1px solid var(--c-gray-200); padding:24px; position:sticky; top:0; height:100vh}
    .brand{display:flex; align-items:center; gap:12px; margin-bottom:24px}
    .brand img.logo{width:56px; height:56px; object-fit:contain; border-radius:8px; background:#fff}
    .brand .title{font-weight:800; letter-spacing:.2px}
    .brand .muted{font-size:12px; color:var(--c-gray-600)}
    .nav a{display:flex; align-items:center; gap:10px; text-decoration:none; color:#3a3a3a; padding:10px 12px; border-radius:10px; font-weight:600}
    .nav a:hover, .nav a.active{background:var(--c-red-100); color:var(--c-red)}

    header{display:flex; align-items:center; justify-content:space-between; padding:18px 26px; position:sticky; top:0; z-index:5; backdrop-filter:saturate(160%) blur(6px); background:rgba(255,255,255,.85); border-bottom:1px solid var(--c-gray-200)}
    header .filters{display:flex; flex-wrap:wrap; gap:12px}
    .select, .input, .button{border:1px solid var(--c-gray-300); background:#fff; padding:10px 12px; border-radius:10px; font:inherit}
    .button{cursor:pointer; border-color:transparent; background:var(--c-red); color:#fff; box-shadow:var(--shadow)}
    .button.gray{background:#fff; color:#111; border:1px solid var(--c-gray-300)}
    .button.warn{background:#8a1a1a}
    .button:disabled{opacity:.6; cursor:not-allowed}

    main{padding:20px 26px; max-width:1500px; margin:0 auto}
    .grid{display:grid; gap:16px}
    .grid.cols-4{grid-template-columns:repeat(4, 1fr)}
    .card{background:#fff; border:1px solid var(--c-gray-200); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px}
    .stat h3{margin:6px 0 2px; font-size:28px}
    .stat p{margin:0; color:var(--c-gray-600)}

    .toolbar{display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between; margin:10px 0 12px}
    .toolbar .left,.toolbar .right{display:flex; gap:8px; align-items:center}

    .table-wrap{overflow:auto; border-radius:var(--radius); border:1px solid var(--c-gray-200); background:#fff}
    table{width:100%; border-collapse:separate; border-spacing:0; min-width:1080px}
    thead th{position:sticky; top:0; z-index:2; background:#fcf5f5; text-align:left; font-size:13px; color:#7a1c1c; border-bottom:1px solid var(--c-gray-200); padding:10px 12px}
    tbody td{border-bottom:1px solid var(--c-gray-100); padding:8px 12px; vertical-align:middle}
    tbody tr:hover{background:#fffafa}
    .num{font-variant-numeric:tabular-nums; text-align:center}
    .tag{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:9999px; font-size:12px; font-weight:700}
    .tag.ok{background:#e9fbef; color:#1b7a43}
    .tag.bad{background:#ffe9e9; color:#8a1a1a}
    .muted{color:var(--c-gray-600)}
    .editable{width:70px}
    input[type="number"]{width:80px; padding:8px 10px; border:1px solid var(--c-gray-300); border-radius:8px; font:inherit; text-align:center}
    input[type="text"].cell{width:100%; padding:8px 10px; border:1px solid var(--c-gray-300); border-radius:8px}

    .note{font-size:12px; color:var(--c-gray-600)}

    /* Modales */
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(16,24,40,.45); z-index:30}
    .modal.open{display:flex}
    .modal .box{background:#fff; width:min(720px, 96vw); border-radius:16px; border:1px solid var(--c-gray-200); box-shadow:var(--shadow); padding:18px}
    .modal .box h3{margin:4px 0 12px}
    .modal .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .modal label{font-size:13px; color:#334155}
    .modal input, .modal select{width:100%; padding:10px 12px; border:1px solid var(--c-gray-300); border-radius:10px; font:inherit}

    /* Historial */
    .history-wrap{margin-top:26px}
    .history-table{min-width:1100px}

    /* Print */
    @media print{
      aside, header, .toolbar, .note, .stat, .actions, .no-print, .history-wrap{display:none !important}
      main{padding:0}
      .table-wrap{border:none}
      thead th{background:#fff}
      body{background:#fff}
    }

    @media (max-width: 980px){
      .app{grid-template-columns:1fr}
      aside{position:static; height:auto}
      .grid.cols-4{grid-template-columns:1fr 1fr}
      thead th:first-child, tbody td:first-child{position:sticky; left:0; background:#fff; border-right:1px solid var(--c-gray-100)}
    }
  </style>
</head>
<body>
  <div class="app">
    <aside>
      <div class="brand">
        <img class="logo" src="https://upload.wikimedia.org/wikipedia/commons/2/21/Logo_del_Ministerio_de_Educaci%C3%B3n_del_Per%C3%BA_-_MINEDU.png" alt="MINEDU"/>
        <div>
          <div class="title">MINISTERIO DE EDUCACI√ìN</div>
          <div class="muted">Panel de Calificaciones</div>
        </div>
      </div>
      <nav class="nav">
        <a class="active" href="#"><span>üè†</span> Dashboard</a>
        <a href="#" id="nav-cargar"><span>üì•</span> Cargar CSV</a>
        <a href="#" id="nav-estudiantes"><span>üë•</span> Estudiantes</a>
        <a href="#" id="nav-calif"><span>üìù</span> Calificaciones</a>
        <a href="#historial" id="nav-hist"><span>üïì</span> Historial</a>
        <a href="#" id="nav-config"><span>‚öôÔ∏è</span> Configuraci√≥n</a>
      </nav>
      <div style="margin-top:auto; padding-top:24px">
        <div class="note">Los cambios se guardan en tu navegador (LocalStorage). Para uso real, conecta tu backend (p. ej., SISE, SIA, o tu API).</div>
      </div>
    </aside>

    <section>
      <header class="no-print">
        <div class="filters">
          <select class="select" id="anio">
            <option value="2025">A√±o lectivo 2025</option>
            <option value="2024">A√±o lectivo 2024</option>
          </select>
          <select class="select" id="nivel">
            <option>Secundaria</option>
            <option>Primaria</option>
            <option>EBE</option>
          </select>
          <select class="select" id="grado">
            <option value="5">5.¬∫</option>
            <option value="4">4.¬∫</option>
            <option value="3">3.¬∫</option>
          </select>
          <select class="select" id="seccion">
            <option value="A">Secci√≥n A</option>
            <option value="B">Secci√≥n B</option>
          </select>
          <select class="select" id="curso">
            <option value="Matem√°tica">Matem√°tica</option>
            <option value="Comunicaci√≥n">Comunicaci√≥n</option>
            <option value="CyT">Ciencia y Tecnolog√≠a</option>
            <option value="Ingl√©s">Ingl√©s</option>
          </select>
        </div>
        <div class="filters">
          <input class="input" id="buscador" placeholder="Buscar por nombre o c√≥digo"/>
          <button class="button gray" id="imprimir">Imprimir acta</button>
          <button class="button" id="btnGuardar">Guardar cambios</button>
        </div>
      </header>

      <main>
        <div class="grid cols-4">
          <div class="card stat"><p>Estudiantes</p><h3 id="stat-est">0</h3></div>
          <div class="card stat"><p>Promedio general</p><h3 id="stat-prom">0</h3></div>
          <div class="card stat"><p>Aprobados</p><h3 id="stat-ok">0</h3></div>
          <div class="card stat"><p>Desaprobados</p><h3 id="stat-bad">0</h3></div>
        </div>

        <div class="toolbar">
          <div class="left">
            <button class="button" id="btnNuevo">Nuevo estudiante</button>
            <button class="button" id="btnCargar">Cargar CSV</button>
            <button class="button gray" id="btnExportar">Exportar CSV</button>
          </div>
          <div class="right">
            <span class="note">Escala 0‚Äì20. Final = promedio de B1‚ÄìB4. Recuperaci√≥n reemplaza si es mayor.</span>
          </div>
        </div>

        <div class="table-wrap">
          <table id="tabla">
            <thead>
              <tr>
                <th style="min-width:150px">C√≥digo de estudiante</th>
                <th style="min-width:180px">Ap. Paterno</th>
                <th style="min-width:180px">Ap. Materno</th>
                <th style="min-width:220px">Nombres</th>
                <th class="num">Bimestre 1 <button class="button gray no-print" data-bulk="b1" style="padding:4px 8px; font-size:12px">‚áß</button></th>
                <th class="num">Bimestre 2 <button class="button gray no-print" data-bulk="b2" style="padding:4px 8px; font-size:12px">‚áß</button></th>
                <th class="num">Bimestre 3 <button class="button gray no-print" data-bulk="b3" style="padding:4px 8px; font-size:12px">‚áß</button></th>
                <th class="num">Bimestre 4 <button class="button gray no-print" data-bulk="b4" style="padding:4px 8px; font-size:12px">‚áß</button></th>
                <th class="num">Recuperaci√≥n <button class="button gray no-print" data-bulk="rec" style="padding:4px 8px; font-size:12px">‚áß</button></th>
                <th class="num">Final</th>
                <th class="num">Estado</th>
                <th class="no-print">Acciones</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <p class="note" style="margin-top:10px">Tip: usa los botones ‚áß para asignar una nota a toda la columna o vaciarla.</p>

        <!-- ===== Historial de cambios ===== -->
        <div class="history-wrap" id="historial">
          <div class="toolbar">
            <div class="left"><h3 style="margin:0">Historial de cambios</h3></div>
            <div class="right">
              <button class="button gray" id="btnSeedDemo">Restaurar demo</button>
              <button class="button gray" id="btnExportHist">Exportar historial CSV</button>
              <button class="button warn" id="btnClearHist">Borrar historial</button>
            </div>
          </div>
          <div class="table-wrap">
            <table class="history-table">
              <thead>
                <tr>
                  <th style="min-width:160px">Fecha</th>
                  <th>Acci√≥n</th>
                  <th style="min-width:260px">Estudiante</th>
                  <th>Campo</th>
                  <th>Antes</th>
                  <th>Despu√©s</th>
                  <th>Usuario</th>
                </tr>
              </thead>
              <tbody id="tbodyHist"></tbody>
            </table>
          </div>
        </div>

        <input id="fileCsv" type="file" accept=".csv" hidden>
      </main>
    </section>
  </div>

  <!-- Modal: Nuevo estudiante -->
  <div class="modal" id="modalNuevo">
    <div class="box">
      <h3>Agregar estudiante</h3>
      <div class="row">
        <div>
          <label>C√≥digo</label>
          <input id="m_codigo" placeholder="Ej. 25-12345"/>
        </div>
        <div>
          <label>Apellido paterno</label>
          <input id="m_apepat"/>
        </div>
        <div>
          <label>Apellido materno</label>
          <input id="m_apemat"/>
        </div>
        <div>
          <label>Nombres</label>
          <input id="m_nombres"/>
        </div>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px">
        <button class="button gray" data-close="#modalNuevo">Cancelar</button>
        <button class="button" id="m_guardar">Agregar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Configuraci√≥n -->
  <div class="modal" id="modalConfig">
    <div class="box">
      <h3>Configuraci√≥n de c√°lculo</h3>
      <div class="row">
        <div>
          <label>Nota m√≠nima aprobatoria</label>
          <input id="cfg_min" type="number" min="0" max="20" step="1" value="11"/>
        </div>
        <div>
          <label>Redondeo</label>
          <select id="cfg_round">
            <option value="nearest">Al m√°s cercano</option>
            <option value="down">Hacia abajo</option>
            <option value="up">Hacia arriba</option>
            <option value="none">Sin redondeo</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label>Peso B1 (0‚Äì1)</label>
          <input id="cfg_w1" type="number" min="0" max="1" step="0.01" value="0.25"/>
        </div>
        <div>
          <label>Peso B2 (0‚Äì1)</label>
          <input id="cfg_w2" type="number" min="0" max="1" step="0.01" value="0.25"/>
        </div>
        <div>
          <label>Peso B3 (0‚Äì1)</label>
          <input id="cfg_w3" type="number" min="0" max="1" step="0.01" value="0.25"/>
        </div>
        <div>
          <label>Peso B4 (0‚Äì1)</label>
          <input id="cfg_w4" type="number" min="0" max="1" step="0.01" value="0.25"/>
        </div>
        <div>
          <label>Recuperaci√≥n sustituye si &gt; Final</label>
          <select id="cfg_rec_over">
            <option value="true">S√≠</option>
            <option value="false">No</option>
          </select>
        </div>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px">
        <button class="button gray" data-close="#modalConfig">Cancelar</button>
        <button class="button" id="cfg_guardar">Guardar</button>
      </div>
    </div>
  </div>

  <script>
    // ====== Estado global ======
    const state = {
      ests: [],
      historial: [],
      cfg: { minAprob: 11, round: 'nearest', w1: .25, w2: .25, w3: .25, w4: .25, recOverrides: true }
    };

    // ====== Datos demo ======
    const demoEsts = [
      {id: uid(), codigo:'25-0001', apepat:'Quispe',  apemat:'Huam√°n',  nombres:'Luc√≠a Marisol', b1:15, b2:14, b3:16, b4:15, rec:''},
      {id: uid(), codigo:'25-0002', apepat:'Rojas',   apemat:'V√°squez', nombres:'Diego Alejandro', b1:10, b2:12, b3:9,  b4:11, rec:12},
      {id: uid(), codigo:'25-0003', apepat:'G√≥mez',   apemat:'Soto',    nombres:'Valentina', b1:18, b2:17, b3:19, b4:18, rec:''},
      {id: uid(), codigo:'25-0004', apepat:'P√©rez',   apemat:'Castro',  nombres:'Javier', b1:11, b2:10, b3:12, b4:10, rec:''},
      {id: uid(), codigo:'25-0005', apepat:'Flores',  apemat:'Salas',   nombres:'Brenda', b1:13, b2:12, b3:14, b4:13, rec:''},
      {id: uid(), codigo:'25-0006', apepat:'Huerta',  apemat:'Cruz',    nombres:'Carlos', b1:8,  b2:9,  b3:10, b4:9,  rec:12},
      {id: uid(), codigo:'25-0007', apepat:'S√°nchez', apemat:'L√≥pez',   nombres:'Paolo', b1:16, b2:15, b3:16, b4:17, rec:''},
      {id: uid(), codigo:'25-0008', apepat:'Ch√°vez',  apemat:'D√≠az',    nombres:'Micaela', b1:14, b2:13, b3:15, b4:14, rec:''}
    ];

    const demoHist = [
      {id: uid(), ts: Date.now()-86400000*4,   usuario:'admin',     accion:'Carga CSV',        est:'8 filas', campo:'‚Äî', antes:'‚Äî', despues:'Importados'},
      {id: uid(), ts: Date.now()-86400000*3.8, usuario:'admin',     accion:'Edici√≥n de nota',  est:'25-0002 ¬∑ Rojas V√°squez, Diego Alejandro', campo:'B3', antes:8,  despues:9},
      {id: uid(), ts: Date.now()-86400000*3.7, usuario:'prof_mate', accion:'Edici√≥n de nota',  est:'25-0006 ¬∑ Huerta Cruz, Carlos', campo:'REC', antes:'‚Äî', despues:12},
      {id: uid(), ts: Date.now()-86400000*3.3, usuario:'prof_mate', accion:'Edici√≥n de nota',  est:'25-0004 ¬∑ P√©rez Castro, Javier', campo:'B2', antes:9,  despues:10},
      {id: uid(), ts: Date.now()-86400000*2.5, usuario:'admin',     accion:'Edici√≥n de datos', est:'25-0008 ¬∑ Ch√°vez D√≠az, Micaela', campo:'Ap. Materno', antes:'Diaz', despues:'D√≠az'},
      {id: uid(), ts: Date.now()-86400000*2.0, usuario:'admin',     accion:'Asignaci√≥n masiva',est:'Todos', campo:'B1', antes:'(varios)', despues:'Revisi√≥n general'},
      {id: uid(), ts: Date.now()-3600*1000*6, usuario:'prof_mate', accion:'Edici√≥n de nota',  est:'25-0001 ¬∑ Quispe Huam√°n, Luc√≠a Marisol', campo:'B4', antes:14, despues:15}
    ];

    // ====== Utils ======
    function uid(){return Math.random().toString(36).slice(2,9)}
    const $ = sel => document.querySelector(sel);
    function clamp(n,min,max){return Math.min(Math.max(n, min), max)}
    function parseNote(v){ if(v===''||v==null) return ''; const n=Number(v); return Number.isNaN(n)?'':clamp(Math.round(n),0,20); }
    function roundBy(mode,v){ if(mode==='none') return v; if(mode==='up') return Math.ceil(v); if(mode==='down') return Math.floor(v); return Math.round(v); }
    function fmtDate(ts){ return new Date(ts).toLocaleString('es-PE',{dateStyle:'short', timeStyle:'short'}); }

    function key(){ const a=$('#anio').value,n=$('#nivel').value,g=$('#grado').value,s=$('#seccion').value,c=$('#curso').value; return `minedu:${a}:${n}:${g}:${s}:${c}` }
    function save(){ localStorage.setItem(key(), JSON.stringify({ests:state.ests, cfg:state.cfg, historial:state.historial})); flash('Cambios guardados'); }
    function load(){
      const raw=localStorage.getItem(key());
      if(raw){
        try{ const data=JSON.parse(raw); state.ests=Array.isArray(data.ests)?data.ests:[]; state.historial=Array.isArray(data.historial)?data.historial:[]; Object.assign(state.cfg,data.cfg||{}); }
        catch(e){ console.warn(e) }
      }
      if(!state.ests.length) state.ests = demoEsts.map(x=>({...x}));
      if(!state.historial.length) state.historial = demoHist.map(x=>({...x}));
    }
    function flash(msg){ const el=document.createElement('div'); el.textContent=msg; Object.assign(el.style,{position:'fixed',right:'16px',bottom:'16px',padding:'10px 14px',background:'var(--c-red)',color:'#fff',borderRadius:'10px',boxShadow:'var(--shadow)',zIndex:99}); document.body.appendChild(el); setTimeout(()=>el.remove(),1600); }

    // ====== C√°lculo ======
    function calcFinal(e){
      const {w1,w2,w3,w4, round, recOverrides, minAprob} = state.cfg;
      const b1=Number(e.b1||0), b2=Number(e.b2||0), b3=Number(e.b3||0), b4=Number(e.b4||0);
      let fin = (b1*w1)+(b2*w2)+(b3*w3)+(b4*w4);
      if(recOverrides && e.rec!=='' && !Number.isNaN(Number(e.rec))) fin=Math.max(fin, Number(e.rec));
      fin = roundBy(round, fin);
      const estado = fin>=minAprob? 'Aprobado':'Desaprobado';
      return {final:fin, estado};
    }

    // ====== Render ======
    function render(){
      const q = ($('#buscador').value||'').toLowerCase();
      const tbody=$('#tbody'); tbody.innerHTML='';
      let sum=0, ok=0, bad=0;
      state.ests.filter(e=>`${e.codigo} ${e.apepat} ${e.apemat} ${e.nombres}`.toLowerCase().includes(q))
        .forEach(e=>{
          const {final, estado}=calcFinal(e); sum+=final; if(estado==='Aprobado') ok++; else bad++;
          const tr=document.createElement('tr');
          tr.innerHTML=`
            <td><input class="cell" data-field="codigo" value="${escapeHtml(e.codigo)}"/></td>
            <td><input class="cell" data-field="apepat" value="${escapeHtml(e.apepat)}"/></td>
            <td><input class="cell" data-field="apemat" value="${escapeHtml(e.apemat)}"/></td>
            <td><input class="cell" data-field="nombres" value="${escapeHtml(e.nombres)}"/></td>
            <td class="num"><input class="editable" type="number" min="0" max="20" step="1" data-field="b1" value="${e.b1!==''?e.b1:''}"/></td>
            <td class="num"><input class="editable" type="number" min="0" max="20" step="1" data-field="b2" value="${e.b2!==''?e.b2:''}"/></td>
            <td class="num"><input class="editable" type="number" min="0" max="20" step="1" data-field="b3" value="${e.b3!==''?e.b3:''}"/></td>
            <td class="num"><input class="editable" type="number" min="0" max="20" step="1" data-field="b4" value="${e.b4!==''?e.b4:''}"/></td>
            <td class="num"><input class="editable" type="number" min="0" max="20" step="1" data-field="rec" value="${e.rec!==''?e.rec:''}"/></td>
            <td class="num">${final}</td>
            <td class="num">${estado==='Aprobado'?'<span class="tag ok">Aprobado</span>':'<span class="tag bad">Desaprobado</span>'}</td>
            <td class="no-print"><button class="button gray" data-del="${e.id}">Eliminar</button></td>`;
          tr.dataset.id=e.id; tbody.appendChild(tr);
        });
      // Stats
      $('#stat-est').textContent = state.ests.length;
      $('#stat-prom').textContent = state.ests.length? Math.round(sum/state.ests.length):0;
      $('#stat-ok').textContent = ok; $('#stat-bad').textContent = bad;

      // Bind inputs con logging
      tbody.querySelectorAll('input').forEach(inp=>{
        inp.addEventListener('focus', e=>{ e.target.dataset.prev=e.target.value; });
        inp.addEventListener('input', e=>{
          const id=e.target.closest('tr').dataset.id; const field=e.target.dataset.field; const est=state.ests.find(x=>x.id===id); if(!est) return;
          let newVal; if(['b1','b2','b3','b4','rec'].includes(field)){ newVal=e.target.value===''?'':parseNote(e.target.value); est[field]=newVal; } else { newVal=e.target.value; est[field]=newVal; }
          const prev=e.target.dataset.prev??''; if(String(prev)!==String(newVal)){
            logCambio({usuario:'admin', accion:['b1','b2','b3','b4','rec'].includes(field)?'Edici√≥n de nota':'Edici√≥n de datos', est:`${est.codigo} ¬∑ ${est.apepat} ${est.apemat}, ${est.nombres}`, campo:field.toUpperCase(), antes: prev===''?'‚Äî':prev, despues: newVal===''?'‚Äî':newVal});
            e.target.dataset.prev=newVal;
          }
          render();
        });
      });

      // Eliminar
      tbody.querySelectorAll('[data-del]').forEach(btn=> btn.addEventListener('click', e=>{
        const id=e.currentTarget.getAttribute('data-del'); const est=state.ests.find(x=>x.id===id); if(!est) return;
        if(confirm(`Eliminar a ${est.nombres}?`)){
          state.ests = state.ests.filter(x=>x.id!==id);
          logCambio({usuario:'admin', accion:'Eliminaci√≥n', est:`${est.codigo} ¬∑ ${est.apepat} ${est.apemat}, ${est.nombres}`, campo:'Fila', antes:'Exist√≠a', despues:'Eliminada'});
          render();
        }
      }));

      renderHistorial();
    }

    function escapeHtml(s=''){ return s.replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[c])); }

    // ====== CSV ======
    function parseCSV(text){ const rows=[]; let i=0, field='', inQ=false, row=[]; while(i<text.length){ const ch=text[i]; if(ch==='"'){ if(inQ && text[i+1]==='"'){ field+='"'; i++; } else inQ=!inQ; } else if(ch===','&&!inQ){ row.push(field); field=''; } else if((ch==='\n'||ch==='\r')&&!inQ){ if(field!==''||row.length){ row.push(field); rows.push(row); row=[]; field=''; } } else { field+=ch } i++; } if(field!==''||row.length){ row.push(field); rows.push(row) } return rows.filter(r=>r.some(c=>c.trim()!=='')); }
    function mapCsvToEsts(rows){ const header=rows[0].map(h=>h.trim().toLowerCase()); const body=header.some(h=>['codigo','c√≥digo','apellidopaterno','apepat','apellido paterno'].includes(h))?rows.slice(1):rows; const idx=name=> header.findIndex(h=> h.replace(/\s+/g,'')===name.replace(/\s+/g,'').toLowerCase()); const iCod=Math.max(idx('codigo'),idx('c√≥digo')); const iPat=Math.max(idx('apellidopaterno'),idx('apepat'),idx('apellido paterno')); const iMat=Math.max(idx('apellidomaterno'),idx('apemat'),idx('apellido materno')); const iNom=Math.max(idx('nombres'),idx('nombre')); const iB1=Math.max(idx('b1'),idx('bimestre1')); const iB2=Math.max(idx('b2'),idx('bimestre2')); const iB3=Math.max(idx('b3'),idx('bimestre3')); const iB4=Math.max(idx('b4'),idx('bimestre4')); const iRec=Math.max(idx('recuperacion'),idx('recuperaci√≥n'),idx('rec'));
      const ests=body.map(r=>({ id:uid(), codigo:get(r,iCod), apepat:get(r,iPat), apemat:get(r,iMat), nombres:get(r,iNom), b1:toNum(get(r,iB1)), b2:toNum(get(r,iB2)), b3:toNum(get(r,iB3)), b4:toNum(get(r,iB4)), rec:toNum(get(r,iRec)) }));
      if(ests.length){ logCambio({usuario:'admin', accion:'Carga CSV', est:`${ests.length} estudiante(s)`, campo:'‚Äî', antes:'‚Äî', despues:'Importados'}); }
      return ests.filter(e=>e.codigo||e.nombres);
      function get(r,i){ return i>=0?(r[i]||'').trim():'' }
      function toNum(v){ return v===''?'':parseNote(v) }
    }
    function toCSV(){ const cols=['Codigo','ApellidoPaterno','ApellidoMaterno','Nombres','B1','B2','B3','B4','Recuperacion','Final','Estado']; const lines=[cols.join(',')]; state.ests.forEach(e=>{ const {final,estado}=calcFinal(e); const row=[e.codigo,e.apepat,e.apemat,e.nombres,e.b1,e.b2,e.b3,e.b4,e.rec,final,estado].map(v=> v===undefined?'':String(v).includes(',')?`"${String(v).replace(/"/g,'""')}"`:v); lines.push(row.join(',')); }); return lines.join('\n'); }
    function historyToCSV(){ const cols=['Fecha','Accion','Estudiante','Campo','Antes','Despues','Usuario']; const lines=[cols.join(',')]; state.historial.forEach(h=>{ const row=[fmtDate(h.ts),h.accion,h.est,h.campo,h.antes,h.despues,h.usuario].map(v=> v===undefined?'':String(v).includes(',')?`"${String(v).replace(/"/g,'""')}"`:v); lines.push(row.join(',')); }); return lines.join('\n'); }

    // ====== Historial ======
    function logCambio({usuario,accion,est,campo,antes,despues}){ state.historial.unshift({id:uid(), ts:Date.now(), usuario, accion, est, campo, antes, despues}); renderHistorial(); save(); }
    function renderHistorial(){ const tbody=$('#tbodyHist'); if(!tbody) return; tbody.innerHTML=''; if(!state.historial.length){ const tr=document.createElement('tr'); tr.innerHTML=`<td colspan="7" style="text-align:center; color:var(--c-gray-600)">Sin movimientos</td>`; tbody.appendChild(tr); return; } state.historial.slice(0,300).forEach(h=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${fmtDate(h.ts)}</td><td>${escapeHtml(h.accion)}</td><td>${escapeHtml(h.est)}</td><td>${escapeHtml(h.campo)}</td><td>${escapeHtml(String(h.antes))}</td><td>${escapeHtml(String(h.despues))}</td><td>${escapeHtml(h.usuario)}</td>`; tbody.appendChild(tr); }); }

    // ====== Eventos UI ======
    function bindUI(){
      $('#btnNuevo').addEventListener('click', ()=> openModal('#modalNuevo'));
      $('#nav-config').addEventListener('click', ()=> openModal('#modalConfig'));
      $('#btnCargar').addEventListener('click', ()=> $('#fileCsv').click());
      $('#nav-cargar').addEventListener('click', ()=> $('#fileCsv').click());
      $('#fileCsv').addEventListener('change', onCsvSelected);
      $('#btnExportar').addEventListener('click', ()=>{ const blob=new Blob([toCSV()],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`calificaciones_${key().replace(/[:\s]/g,'_')}.csv`; a.click(); URL.revokeObjectURL(url); });
      $('#btnGuardar').addEventListener('click', save);
      $('#imprimir').addEventListener('click', ()=> window.print());
      $('#buscador').addEventListener('input', render);

      document.querySelectorAll('[data-bulk]').forEach(btn=> btn.addEventListener('click', ()=>{ const map={b1:'b1',b2:'b2',b3:'b3',b4:'b4',rec:'rec'}; bulkPrompt(map[btn.dataset.bulk]); }));

      ['anio','nivel','grado','seccion','curso'].forEach(id=> $('#'+id).addEventListener('change', ()=>{ load(); render(); }));

      // Modal Nuevo
      $('#m_guardar').addEventListener('click', ()=>{ const est={ id:uid(), codigo:$('#m_codigo').value.trim(), apepat:$('#m_apepat').value.trim(), apemat:$('#m_apemat').value.trim(), nombres:$('#m_nombres').value.trim(), b1:'',b2:'',b3:'',b4:'',rec:'' }; if(!est.codigo||!est.nombres){ alert('C√≥digo y nombres son obligatorios'); return; } state.ests.push(est); logCambio({usuario:'admin', accion:'Alta', est:`${est.codigo} ¬∑ ${est.apepat} ${est.apemat}, ${est.nombres}`, campo:'Fila', antes:'‚Äî', despues:'Creada'}); closeModal('#modalNuevo'); render(); });

      // Configuraci√≥n
      $('#cfg_guardar').addEventListener('click', ()=>{ const totalW=Number($('#cfg_w1').value)+Number($('#cfg_w2').value)+Number($('#cfg_w3').value)+Number($('#cfg_w4').value); if(Math.abs(totalW-1)>0.001){ alert('La suma de pesos debe ser 1.0'); return; } const prev={...state.cfg}; state.cfg.minAprob=parseNote($('#cfg_min').value); state.cfg.round=$('#cfg_round').value; state.cfg.w1=Number($('#cfg_w1').value); state.cfg.w2=Number($('#cfg_w2').value); state.cfg.w3=Number($('#cfg_w3').value); state.cfg.w4=Number($('#cfg_w4').value); state.cfg.recOverrides=$('#cfg_rec_over').value==='true'; closeModal('#modalConfig'); render(); logCambio({usuario:'admin', accion:'Configuraci√≥n', est:'‚Äî', campo:'Pesos/Reglas', antes: JSON.stringify(prev), despues: JSON.stringify(state.cfg)}); });

      // Historial
      $('#btnSeedDemo').addEventListener('click', ()=>{ if(confirm('¬øRestaurar datos de demostraci√≥n para este grupo? Esto reemplazar√° estudiantes e historial actuales.')){ state.ests=demoEsts.map(x=>({...x})); state.historial=demoHist.map(x=>({...x})); save(); render(); flash('Datos demo restaurados'); } });
      $('#btnExportHist').addEventListener('click', ()=>{ const blob=new Blob([historyToCSV()],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`historial_${key().replace(/[:\s]/g,'_')}.csv`; a.click(); URL.revokeObjectURL(url); });
      $('#btnClearHist').addEventListener('click', ()=>{ if(confirm('¬øBorrar todo el historial de este grupo?')){ state.historial=[]; renderHistorial(); save(); } });

      // Cerrar modales
      document.querySelectorAll('[data-close]').forEach(btn=> btn.addEventListener('click', ()=> closeModal(btn.getAttribute('data-close'))));
      document.querySelectorAll('.modal').forEach(m=> m.addEventListener('click', e=>{ if(e.target===m) closeModal('#'+m.id) }));
    }

    function onCsvSelected(e){ const f=e.target.files[0]; if(!f) return; const reader=new FileReader(); reader.onload=()=>{ const rows=parseCSV(reader.result); const ests=mapCsvToEsts(rows); if(!ests.length){ alert('No se detectaron filas v√°lidas. Revisa el CSV.'); return; } if(confirm(`Se cargar√°n ${ests.length} estudiantes. Esto reemplazar√° a los existentes en este grupo. ¬øContinuar?`)){ state.ests=ests; render(); } }; reader.readAsText(f,'utf-8'); e.target.value=''; }

    function bulkPrompt(field){ const action=prompt('Escribe una nota 0-20 para asignar a toda la columna, o deja vac√≠o para vaciar.'); if(action===null) return; const v=action.trim()===''?'':parseNote(action); state.ests.forEach(e=> e[field]=v); logCambio({usuario:'admin', accion:'Asignaci√≥n masiva', est:'Todos', campo:field.toUpperCase(), antes:'(varios)', despues: v===''?'vac√≠o':v}); render(); }

    // ====== Modales ======
    function openModal(sel){ document.querySelector(sel).classList.add('open') }
    function closeModal(sel){ document.querySelector(sel).classList.remove('open') }

    // ====== Inicio ======
    load();
    bindUI();
    render();
  </script>
</body>
</html>
