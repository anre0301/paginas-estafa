<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UTP · Panel Docente (Administrador)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --utp:#b10000; --ink:#0f172a; --muted:#64748b; }
    html { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', 'Noto Sans', Arial; }
    ::-webkit-scrollbar{width:10px;height:10px}::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:8px}::-webkit-scrollbar-thumb:hover{background:#94a3b8}
    @media print { #sidebar, #toolbar, #acciones, #importCsvBtn, #importCsv, .no-print { display:none !important; } main{margin-left:0!important} .card{box-shadow:none!important;border:1px solid #e2e8f0!important} }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <!-- Sidebar -->
  <aside id="sidebar" class="fixed inset-y-0 left-0 w-76 md:w-80 bg-white border-r border-slate-200/80 z-40">
    <div class="h-20 px-5 flex items-center gap-3 border-b border-slate-200/80">
      <img src="https://s3.amazonaws.com/media.greatplacetowork.com/peru/best-workplaces-in-peru/2025/3-mas-de-1000/12-utp/logo.png" alt="Logo UTP" class="h-10 w-auto object-contain"/>
      <div>
        <div class="font-extrabold tracking-tight">Panel Docente</div>
        <div class="text-xs text-slate-500 -mt-0.5">Administrador académico</div>
      </div>
    </div>

    <div class="p-5 border-b border-slate-200/80">
      <div class="text-xs uppercase text-slate-400 font-semibold mb-2">Profesor</div>
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-full bg-slate-100 grid place-items-center text-slate-500">👨‍🏫</div>
        <div class="flex-1">
          <div class="font-semibold" id="profNombre">Docente UTP</div>
          <div class="text-xs text-slate-500" id="profEscuela">Escuela: Ing. de Software</div>
        </div>
      </div>
      <div class="flex gap-2 mt-3">
        <button id="configBtn" class="text-sm px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">Configurar</button>
        <button id="temaBtn" class="text-sm px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">🌗 Tema</button>
      </div>
    </div>

    <nav class="p-3 space-y-1 text-sm">
      <a href="#dashboard" class="flex items-center gap-3 px-3 py-2 rounded-xl bg-slate-100 font-semibold">🏠 <span>Dashboard</span></a>
      <a href="#alumnos" class="flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-100">👥 <span>Alumnos</span></a>
      <a href="#cursos" class="flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-100">📚 <span>Cursos</span></a>
      <a href="#actas" class="flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-100">📝 <span>Actas</span></a>
      <a href="#reportes" class="flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-100">📈 <span>Reportes</span></a>
    </nav>

    <div class="p-5 space-y-2" id="acciones">
      <div class="text-xs uppercase text-slate-400 font-semibold">Acciones rápidas</div>
      <label class="inline-flex items-center justify-between gap-3 px-3 py-2 rounded-xl border border-slate-200 hover:bg-slate-50 cursor-pointer">
        <span>📥 Importar alumnos (.csv)</span>
        <input id="importCsv" type="file" accept=".csv" class="hidden" />
        <span id="importCsvBtn" class="text-xs text-white px-2 py-1 rounded-lg" style="background:var(--utp)">Elegir</span>
      </label>
      <button id="exportCsvBtn" class="px-3 py-2 rounded-xl border border-slate-200 hover:bg-slate-50">⬇️ Exportar notas</button>
      <button id="addAlumnoBtn" class="px-3 py-2 rounded-xl border border-slate-200 hover:bg-slate-50">➕ Nuevo alumno</button>
      <button id="publicarActasBtn" class="px-3 py-2 rounded-xl border border-emerald-200 text-emerald-700 hover:bg-emerald-50">✅ Publicar actas</button>
      <button id="resetDemoBtn" class="px-3 py-2 rounded-xl border border-rose-200 text-rose-600 hover:bg-rose-50">♻️ Restablecer demo</button>
      <button id="seed20Btn" class="px-3 py-2 rounded-xl border border-indigo-200 text-indigo-700 hover:bg-indigo-50">🌱 Poblar demo (20)</button>
      <details class="mt-1 rounded-xl border border-slate-200 bg-slate-50/60 p-3">
        <summary class="text-sm font-semibold cursor-pointer">Formato CSV</summary>
        <p class="mt-2 text-sm text-slate-600">Cabeceras: <code class="px-1.5 py-0.5 rounded bg-white border">codigo,alumno,curso,seccion,ciclo,pc1,pc2,ep,ef</code></p>
        <pre class="mt-2 bg-white p-3 rounded-lg border overflow-x-auto text-sm">codigo,alumno,curso,seccion,ciclo,pc1,pc2,ep,ef
U20250001,Andrea Ramos,Programación I,A,2025-1,19,19,18,20
U20250002,Juan Pérez,Programación I,A,2025-1,18,17,19,20</pre>
      </details>
    </div>
  </aside>

  <!-- Topbar -->
  <header id="toolbar" class="fixed left-[20.5rem] md:left-80 right-0 top-0 h-20 bg-white/80 backdrop-blur border-b border-slate-200/80 z-30">
    <div class="h-full px-6 flex items-center gap-3">
      <div class="text-2xl font-extrabold tracking-tight">Administrador académico</div>
      <div class="ml-auto flex items-center gap-3">
        <img src="https://s3.amazonaws.com/media.greatplacetowork.com/peru/best-workplaces-in-peru/2025/3-mas-de-1000/12-utp/logo.png" alt="UTP" class="h-8 w-auto object-contain"/>
        <input id="search" type="search" placeholder="Buscar alumno o código…" class="px-3 py-2 rounded-lg border border-slate-200 w-64 focus:outline-none focus:ring-4 focus:ring-slate-100" />
        <select id="filtroCurso" class="px-3 py-2 rounded-lg border border-slate-200 min-w-40"></select>
        <select id="filtroSeccion" class="px-3 py-2 rounded-lg border border-slate-200 min-w-36"></select>
        <select id="filtroCiclo" class="px-3 py-2 rounded-lg border border-slate-200 min-w-32"></select>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="pt-24 pl-[20.5rem] md:pl-80 pr-6 pb-10 max-w-[2000px]">
    <!-- Métricas -->
    <section id="dashboard" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
      <div class="card p-5 rounded-2xl bg-white border border-slate-200 shadow-sm">
        <div class="text-sm text-slate-500">Total alumnos</div>
        <div class="mt-1 text-3xl font-extrabold" id="mTotal">—</div>
      </div>
      <div class="card p-5 rounded-2xl bg-white border border-slate-200 shadow-sm">
        <div class="text-sm text-slate-500">Promedio global</div>
        <div class="mt-1 text-3xl font-extrabold" id="mPromedio">—</div>
        <div class="mt-3 h-2 bg-slate-100 rounded-full overflow-hidden"><div id="mPromBar" class="h-full" style="background:linear-gradient(90deg,var(--utp),#ff7777);width:0%"></div></div>
      </div>
      <div class="card p-5 rounded-2xl bg-white border border-slate-200 shadow-sm">
        <div class="text-sm text-slate-500">Desaprobados</div>
        <div class="mt-1 text-3xl font-extrabold text-amber-600" id="mDesaprob">—</div>
        <div class="mt-2 text-xs text-slate-500">Umbral configurable</div>
      </div>
      <div class="card p-5 rounded-2xl bg-white border border-slate-200 shadow-sm">
        <div class="text-sm text-slate-500">Actas pendientes</div>
        <div class="mt-1 text-3xl font-extrabold" id="mActas">—</div>
      </div>
    </section>

    <!-- Tabla Alumnos -->
    <section id="alumnos" class="mt-6">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-3">
          <h2 class="text-xl font-extrabold tracking-tight">Alumnos</h2>
          <span id="totalFiltrados" class="text-sm text-slate-500"></span>
        </div>
        <div class="flex items-center gap-2">
          <button id="bulkSeccionBtn" class="no-print px-3 py-2 rounded-xl border border-slate-200 hover:bg-slate-50">Mover a sección…</button>
          <button id="bulkCursoBtn" class="no-print px-3 py-2 rounded-xl border border-slate-200 hover:bg-slate-50">Cambiar curso…</button>
        </div>
      </div>

      <div class="overflow-hidden rounded-2xl border border-slate-200 bg-white">
        <table class="w-full text-sm" id="tablaAlumnos">
          <thead class="bg-slate-50 text-slate-600">
            <tr>
              <th class="px-4 py-3"><input id="chkAll" type="checkbox"/></th>
              <th class="px-4 py-3 text-left">Código <button data-sort="codigo" class="ml-1 text-xs text-slate-400">↕</button></th>
              <th class="px-4 py-3 text-left">Alumno <button data-sort="alumno" class="ml-1 text-xs text-slate-400">↕</button></th>
              <th class="px-4 py-3 text-left">Curso <button data-sort="curso" class="ml-1 text-xs text-slate-400">↕</button></th>
              <th class="px-4 py-3 text-left">Sección <button data-sort="seccion" class="ml-1 text-xs text-slate-400">↕</button></th>
              <th class="px-4 py-3 text-left">Ciclo <button data-sort="ciclo" class="ml-1 text-xs text-slate-400">↕</button></th>
              <th class="px-4 py-3 text-left">PC1</th>
              <th class="px-4 py-3 text-left">PC2</th>
              <th class="px-4 py-3 text-left">EP</th>
              <th class="px-4 py-3 text-left">EF</th>
              <th class="px-4 py-3 text-left">Promedio</th>
              <th class="px-4 py-3 text-left">Estado</th>
              <th class="px-4 py-3 text-left">Acciones</th>
            </tr>
          </thead>
          <tbody id="tbodyAlumnos" class="divide-y divide-slate-200"></tbody>
        </table>
      </div>
    </section>

    <!-- Cursos -->
    <section id="cursos" class="mt-8">
      <h2 class="text-xl font-extrabold tracking-tight mb-3">Cursos</h2>
      <div id="listaCursos" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4"></div>
    </section>

    <!-- Actas -->
    <section id="actas" class="mt-8">
      <h2 class="text-xl font-extrabold tracking-tight mb-3">Actas</h2>
      <div id="actasPend" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
    </section>

    <!-- Reportes -->
    <section id="reportes" class="mt-8 grid grid-cols-1 xl:grid-cols-3 gap-4">
      <div class="card p-5 rounded-2xl bg-white border border-slate-200 shadow-sm xl:col-span-2">
        <div class="text-sm text-slate-500">Distribución de promedios</div>
        <div class="mt-3 grid grid-cols-2 md:grid-cols-4 gap-3" id="distProm"></div>
      </div>
      <div class="card p-5 rounded-2xl bg-white border border-slate-200 shadow-sm">
        <div class="text-sm text-slate-500">Sugerencias</div>
        <ul id="tips" class="mt-2 list-disc list-inside text-slate-700 space-y-1 text-sm"></ul>
      </div>
    </section>
  </main>

  <!-- Modal Configuración -->
  <dialog id="configModal" class="rounded-2xl p-0 w-[620px] max-w-[94vw]">
    <form method="dialog" class="p-6 bg-white rounded-2xl border border-slate-200">
      <div class="text-xl font-extrabold">Configuración</div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <label class="text-sm">Nombre
          <input id="cfgNombre" class="mt-1 w-full px-3 py-2 border rounded-lg" placeholder="Tu nombre" />
        </label>
        <label class="text-sm">Escuela
          <input id="cfgEscuela" class="mt-1 w-full px-3 py-2 border rounded-lg" placeholder="Ej: Ing. de Software" />
        </label>
        <label class="text-sm">Umbral de aprobación (0–20)
          <input id="cfgUmbral" type="number" min="0" max="20" class="mt-1 w-full px-3 py-2 border rounded-lg" />
        </label>
      </div>
      <div class="mt-5 flex justify-end gap-2">
        <button value="cancel" class="px-3 py-2 rounded-lg border">Cancelar</button>
        <button id="cfgGuardar" value="default" class="px-3 py-2 rounded-lg text-white" style="background:var(--utp)">Guardar</button>
      </div>
    </form>
  </dialog>

  <!-- Modal Alumno -->
  <dialog id="alumnoModal" class="rounded-2xl p-0 w-[620px] max-w-[94vw]">
    <form method="dialog" class="p-6 bg-white rounded-2xl border border-slate-200">
      <div class="text-xl font-extrabold" id="alumnoModalTitulo">Nuevo alumno</div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <label class="text-sm">Código
          <input id="mCodigo" class="mt-1 w-full px-3 py-2 border rounded-lg" required />
        </label>
        <label class="text-sm">Alumno
          <input id="mAlumno" class="mt-1 w-full px-3 py-2 border rounded-lg" required />
        </label>
        <label class="text-sm">Curso
          <input id="mCurso" class="mt-1 w-full px-3 py-2 border rounded-lg" placeholder="Ej: Programación I" required />
        </label>
        <label class="text-sm">Sección
          <input id="mSeccion" class="mt-1 w-full px-3 py-2 border rounded-lg" placeholder="Ej: A" required />
        </label>
        <label class="text-sm">Ciclo
          <input id="mCiclo" class="mt-1 w-full px-3 py-2 border rounded-lg" placeholder="Ej: 2025-1" required />
        </label>
        <label class="text-sm">PC1
          <input id="mPC1" type="number" step="0.1" min="0" max="20" class="mt-1 w-full px-3 py-2 border rounded-lg" />
        </label>
        <label class="text-sm">PC2
          <input id="mPC2" type="number" step="0.1" min="0" max="20" class="mt-1 w-full px-3 py-2 border rounded-lg" />
        </label>
        <label class="text-sm">EP
          <input id="mEP" type="number" step="0.1" min="0" max="20" class="mt-1 w-full px-3 py-2 border rounded-lg" />
        </label>
        <label class="text-sm">EF
          <input id="mEF" type="number" step="0.1" min="0" max="20" class="mt-1 w-full px-3 py-2 border rounded-lg" />
        </label>
      </div>
      <input type="hidden" id="mId" />
      <div class="mt-5 flex justify-end gap-2">
        <button value="cancel" class="px-3 py-2 rounded-lg border">Cancelar</button>
        <button id="mGuardar" value="default" class="px-3 py-2 rounded-lg text-white" style="background:var(--utp)">Guardar</button>
      </div>
    </form>
  </dialog>

  <!-- Modales Bulk -->
  <dialog id="bulkModal" class="rounded-2xl p-0 w-[520px] max-w-[94vw]">
    <form method="dialog" class="p-6 bg-white rounded-2xl border border-slate-200">
      <div class="text-xl font-extrabold" id="bulkTitulo">Acción masiva</div>
      <div class="mt-4" id="bulkContenido"></div>
      <div class="mt-5 flex justify-end gap-2">
        <button value="cancel" class="px-3 py-2 rounded-lg border">Cancelar</button>
        <button id="bulkGuardar" value="default" class="px-3 py-2 rounded-lg text-white" style="background:var(--utp)">Aplicar</button>
      </div>
    </form>
  </dialog>

  <script>
    const LS_KEY = 'utp_admin_v1';
    const $ = (s,el=document)=>el.querySelector(s);
    const $$ = (s,el=document)=>Array.from(el.querySelectorAll(s));

    const state = {
      umbral: 11,
      docente: { nombre:'Docente UTP', escuela:'Ing. de Software' },
      alumnos: [], // {id,codigo,alumno,curso,seccion,ciclo,pc1,pc2,ep,ef,acta:boolean}
    };

    const demoAlumnos = [
      a('U20250001','Andrea Ramos','Programación I','A','2025-1',19,19,18,20),
      a('U20250002','Juan Pérez','Programación I','A','2025-1',18,17,19,20),
      a('U20250003','Lucía Gómez','Programación I','A','2025-1',20,20,19,19),
      a('U20250004','Carlos Diaz','Programación I','B','2025-1',17,18,19,18),
      a('U20250005','María Torres','Base de Datos I','A','2025-2',20,19,18,19),
      a('U20250006','Pedro Salazar','Base de Datos I','A','2025-2',19,18,20,19),
      a('U20250007','Ana Castillo','Álgebra Lineal','B','2025-2',18,19,18,20),
      a('U20250008','Diego Rojas','Álgebra Lineal','B','2025-2',20,18,19,20),
      a('U20250009','Rosa Medina','Física I','A','2025-2',19,20,20,19),
      a('U20250010','Mario López','Física I','A','2025-2',20,19,19,20),
      a('U20250011','Jimena Vega','Comunicación','C','2025-1',19,19,19,20),
      a('U20250012','Bruno Reyes','Comunicación','C','2025-1',18,20,19,19)
    ];

    function a(codigo,alumno,curso,seccion,ciclo,pc1=0,pc2=0,ep=0,ef=0){
      return { id:crypto.randomUUID(), codigo, alumno, curso, seccion, ciclo, pc1:Number(pc1)||0, pc2:Number(pc2)||0, ep:Number(ep)||0, ef:Number(ef)||0, acta:false };
    }

    function load(){
      const raw = localStorage.getItem(LS_KEY);
      if(raw){
        try{ Object.assign(state, JSON.parse(raw)); }catch{}
      }
      // Si no hay alumnos (primera vez o datos viejos), cargar demo
      if(!Array.isArray(state.alumnos) || state.alumnos.length===0){
        state.alumnos = demoAlumnos.slice();
      }
    }
    function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

    function promedio(x){
      // Ponderaciones: PC1 20%, PC2 20%, EP 25%, EF 35%
      return +( (x.pc1*0.2) + (x.pc2*0.2) + (x.ep*0.25) + (x.ef*0.35) ).toFixed(2);
    }

    // ===== Render =====
    function render(){
      $('#profNombre').textContent = state.docente.nombre;
      $('#profEscuela').textContent = 'Escuela: ' + state.docente.escuela;

      // Filtros
      fillSelect($('#filtroCurso'), ['Todos los cursos', ...unique(state.alumnos.map(x=>x.curso))]);
      fillSelect($('#filtroSeccion'), ['Todas las secciones', ...unique(state.alumnos.map(x=>x.seccion))]);
      fillSelect($('#filtroCiclo'), ['Todos los ciclos', ...unique(state.alumnos.map(x=>x.ciclo)).sort()]);

      // Tabla alumnos
      drawTable();

      // Métricas
      const total = state.alumnos.length;
      const proms = state.alumnos.map(promedio);
      const promGlobal = proms.length? (proms.reduce((a,b)=>a+b,0)/proms.length) : 0;
      const desap = state.alumnos.filter(x=>promedio(x) < state.umbral).length;
      const actasPend = state.alumnos.filter(x=>!x.acta).length;

      $('#mTotal').textContent = total;
      $('#mPromedio').textContent = proms.length? promGlobal.toFixed(2) : '—';
      $('#mPromBar').style.width = Math.min(100,(promGlobal/20)*100) + '%';
      $('#mDesaprob').textContent = desap;
      $('#mActas').textContent = actasPend;

      // Cursos cards
      drawCursos();

      // Actas
      drawActas();

      // Reportes
      drawReportes();

      save();
    }

    function fillSelect(sel, items){
      const val = sel.value;
      sel.innerHTML = '';
      items.forEach((t,i)=>{
        const opt = document.createElement('option');
        opt.value = i===0? '' : t; opt.textContent = t; if(t===val) opt.selected=true; sel.appendChild(opt);
      });
    }

    function drawTable(){
      const term = $('#search').value?.toLowerCase()||'';
      const fCurso = $('#filtroCurso').value||'';
      const fSeccion = $('#filtroSeccion').value||'';
      const fCiclo = $('#filtroCiclo').value||'';

      const data = state.alumnos.filter(x=>
        (!fCurso || x.curso===fCurso) &&
        (!fSeccion || x.seccion===fSeccion) &&
        (!fCiclo || x.ciclo===fCiclo) &&
        (!term || x.alumno.toLowerCase().includes(term) || x.codigo.toLowerCase().includes(term))
      );
      $('#totalFiltrados').textContent = `(${data.length} mostrados)`;

      const tbody = $('#tbodyAlumnos'); tbody.innerHTML='';
      data.forEach(x=>{
        const prom = promedio(x);
        const aprobado = prom >= state.umbral;
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-slate-50/60';
        tr.innerHTML = `
          <td class="px-4 py-3"><input type="checkbox" data-chk="${x.id}"></td>
          <td class="px-4 py-3 font-mono">${x.codigo}</td>
          <td class="px-4 py-3 font-medium">${x.alumno}</td>
          <td class="px-4 py-3">${x.curso}</td>
          <td class="px-4 py-3">${x.seccion}</td>
          <td class="px-4 py-3">${x.ciclo}</td>
          <td class="px-2 py-2">${notaInput(x.id,'pc1',x.pc1)}</td>
          <td class="px-2 py-2">${notaInput(x.id,'pc2',x.pc2)}</td>
          <td class="px-2 py-2">${notaInput(x.id,'ep',x.ep)}</td>
          <td class="px-2 py-2">${notaInput(x.id,'ef',x.ef)}</td>
          <td class="px-4 py-3 ${aprobado?'text-emerald-700':'text-amber-700'} font-semibold">${prom}</td>
          <td class="px-4 py-3">${aprobado? '<span class="px-2.5 py-1 rounded-lg text-xs bg-emerald-100 text-emerald-800">Aprobado</span>' : '<span class="px-2.5 py-1 rounded-lg text-xs bg-amber-100 text-amber-800">En riesgo</span>'}</td>
          <td class="px-4 py-3">
            <button class="px-2 py-1 text-xs rounded-lg border hover:bg-slate-50" data-edit="${x.id}">Editar</button>
            <button class="ml-2 px-2 py-1 text-xs rounded-lg border border-rose-200 text-rose-600 hover:bg-rose-50" data-del="${x.id}">Eliminar</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function notaInput(id,key,val){
      return `<input data-nid="${id}" data-key="${key}" type="number" step="0.1" min="0" max="20" value="${val}" class="w-16 px-2 py-1 border rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-200"/>`;
    }

    function drawCursos(){
      const el = $('#listaCursos'); el.innerHTML='';
      const cursos = groupBy(state.alumnos, x=>x.curso);
      Object.entries(cursos).forEach(([curso, items])=>{
        const proms = items.map(promedio);
        const prom = proms.length? (proms.reduce((a,b)=>a+b,0)/proms.length).toFixed(2) : 0;
        const desap = items.filter(x=>promedio(x)<state.umbral).length;
        const card = document.createElement('div');
        card.className = 'p-5 rounded-2xl bg-white border border-slate-200 shadow-sm';
        card.innerHTML = `
          <div class="text-sm text-slate-500">${curso}</div>
          <div class="mt-1 text-2xl font-extrabold">${items.length} alumnos</div>
          <div class="mt-2 text-sm">Promedio: <b>${prom}</b> · Desaprob: <b class="${desap? 'text-amber-700':''}">${desap}</b></div>`;
        el.appendChild(card);
      });
    }

    function drawActas(){
      const el = $('#actasPend'); el.innerHTML='';
      const porCurso = groupBy(state.alumnos.filter(x=>!x.acta), x=>`${x.curso} · ${x.seccion} · ${x.ciclo}`);
      Object.entries(porCurso).forEach(([k,items])=>{
        const card = document.createElement('div');
        card.className = 'p-5 rounded-2xl bg-white border border-slate-200 shadow-sm';
        const proms = items.map(promedio);
        const prom = proms.length? (proms.reduce((a,b)=>a+b,0)/proms.length).toFixed(2) : 0;
        card.innerHTML = `<div class="text-sm text-slate-500">${k}</div>
          <div class="mt-1 text-xl font-extrabold">${items.length} alumnos</div>
          <div class="mt-2 text-sm">Promedio: <b>${prom}</b></div>
          <div class="mt-4"><button class="px-3 py-2 rounded-lg text-white" style="background:var(--utp)" data-publicar="${k}">Publicar acta</button></div>`;
        el.appendChild(card);
      });
    }

    function drawReportes(){
      const buckets = [
        {r:'0–10', f:x=>promedio(x)<=10},
        {r:'11–13', f:x=>{const p=promedio(x); return p>=11 && p<=13}},
        {r:'14–17', f:x=>{const p=promedio(x); return p>=14 && p<=17}},
        {r:'18–20', f:x=>promedio(x)>=18}
      ];
      const dist = $('#distProm'); dist.innerHTML='';
      buckets.forEach(b=>{
        const n = state.alumnos.filter(b.f).length;
        const card = document.createElement('div');
        card.className = 'p-4 rounded-xl border border-slate-200 bg-white shadow-sm';
        card.innerHTML = `<div class="text-xs text-slate-500">${b.r}</div><div class="text-2xl font-extrabold">${n}</div>`;
        dist.appendChild(card);
      });

      const tips = $('#tips'); tips.innerHTML='';
      const desap = state.alumnos.filter(x=>promedio(x) < state.umbral).length;
      if (desap>0) tips.appendChild(li('Reforzar evaluaciones de alumnos en riesgo.'));
      const promGlobal = state.alumnos.length? (state.alumnos.map(promedio).reduce((a,b)=>a+b,0)/state.alumnos.length) : 0;
      if (state.alumnos.length && promGlobal<14) tips.appendChild(li('Revisar rúbricas: promedio global &lt; 14.'));
      if (!tips.children.length) tips.appendChild(li('¡Buen trabajo! Métricas saludables.'));
    }

    function li(t){ const el=document.createElement('li'); el.textContent=t; return el; }

    // ===== Eventos =====
    function openConfig(){
      $('#cfgNombre').value = state.docente.nombre;
      $('#cfgEscuela').value = state.docente.escuela;
      $('#cfgUmbral').value = state.umbral;
      $('#configModal').showModal();
    }
    function saveConfig(ev){
      ev?.preventDefault();
      state.docente.nombre = $('#cfgNombre').value || state.docente.nombre;
      state.docente.escuela = $('#cfgEscuela').value || state.docente.escuela;
      const u = parseFloat($('#cfgUmbral').value||state.umbral);
      state.umbral = Math.min(20, Math.max(0, u));
      $('#configModal').close();
      render();
    }

    function openAlumno(x){
      $('#alumnoModalTitulo').textContent = x? 'Editar alumno' : 'Nuevo alumno';
      $('#mCodigo').value = x?.codigo || '';
      $('#mAlumno').value = x?.alumno || '';
      $('#mCurso').value = x?.curso || '';
      $('#mSeccion').value = x?.seccion || '';
      $('#mCiclo').value = x?.ciclo || '';
      $('#mPC1').value = x?.pc1 ?? '';
      $('#mPC2').value = x?.pc2 ?? '';
      $('#mEP').value = x?.ep ?? '';
      $('#mEF').value = x?.ef ?? '';
      $('#mId').value = x?.id || '';
      $('#alumnoModal').showModal();
    }

    function saveAlumno(ev){
      ev?.preventDefault();
      const d = {
        id: $('#mId').value || crypto.randomUUID(),
        codigo: $('#mCodigo').value.trim(),
        alumno: $('#mAlumno').value.trim(),
        curso: $('#mCurso').value.trim(),
        seccion: $('#mSeccion').value.trim(),
        ciclo: $('#mCiclo').value.trim(),
        pc1: num($('#mPC1').value), pc2: num($('#mPC2').value), ep: num($('#mEP').value), ef: num($('#mEF').value),
        acta: false,
      };
      if (!d.codigo || !d.alumno || !d.curso || !d.seccion || !d.ciclo) return;
      const i = state.alumnos.findIndex(x=>x.id===d.id);
      if (i>-1) state.alumnos[i]=d; else state.alumnos.push(d);
      $('#alumnoModal').close();
      render();
    }

    function num(v){ v=String(v||'').replace(',','.'); const n=parseFloat(v); return isNaN(n)?0:n; }

    function delAlumno(id){ state.alumnos = state.alumnos.filter(x=>x.id!==id); render(); }

    function exportCSV(){
      const rows = [['codigo','alumno','curso','seccion','ciclo','pc1','pc2','ep','ef','promedio'], ...state.alumnos.map(x=>[x.codigo,x.alumno,x.curso,x.seccion,x.ciclo,x.pc1,x.pc2,x.ep,x.ef,promedio(x)])];
      const csv = rows.map(r=>r.join(',')).join('
');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='notas_utp_admin.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    function parseCSV(text){
      const lines = text.split(/
?
/).filter(Boolean);
      const [h,...rows] = lines;
      const headers = h.split(',').map(x=>x.trim().toLowerCase());
      const idx = {
        codigo: headers.indexOf('codigo'), alumno: headers.indexOf('alumno'), curso: headers.indexOf('curso'), seccion: headers.indexOf('seccion'), ciclo: headers.indexOf('ciclo'), pc1: headers.indexOf('pc1'), pc2: headers.indexOf('pc2'), ep: headers.indexOf('ep'), ef: headers.indexOf('ef')
      };
      if ([idx.codigo,idx.alumno,idx.curso,idx.seccion,idx.ciclo].some(v=>v===-1)) throw new Error('Cabeceras mínimas faltantes');
      const out = rows.map(r=>{
        const c = r.split(',');
        return a(
          c[idx.codigo]?.trim()||'',
          c[idx.alumno]?.trim()||'',
          c[idx.curso]?.trim()||'',
          c[idx.seccion]?.trim()||'',
          c[idx.ciclo]?.trim()||'',
          num(c[idx.pc1]||0), num(c[idx.pc2]||0), num(c[idx.ep]||0), num(c[idx.ef]||0)
        );
      }).filter(x=>x.codigo && x.alumno);
      return out;
    }

    // Helpers
    function unique(arr){ return [...new Set(arr.filter(Boolean))]; }
    function groupBy(arr, fn){ return arr.reduce((acc,x)=>{ const k=fn(x); (acc[k]=acc[k]||[]).push(x); return acc; },{}); }

    // ===== Listeners =====
    $('#configBtn').addEventListener('click', openConfig);
    $('#cfgGuardar').addEventListener('click', saveConfig);

    $('#addAlumnoBtn').addEventListener('click', ()=>openAlumno());
    $('#mGuardar').addEventListener('click', saveAlumno);

    $('#tbodyAlumnos').addEventListener('input', (e)=>{
      const inp = e.target.closest('input[type="number"]');
      if(!inp) return;
      const id = inp.dataset.nid; const key = inp.dataset.key; const val = num(inp.value);
      const x = state.alumnos.find(a=>a.id===id); if(!x) return;
      x[key] = Math.min(20, Math.max(0, val));
      render();
    });

    $('#tbodyAlumnos').addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const id = btn.dataset.edit || btn.dataset.del;
      if(btn.dataset.edit){ const x = state.alumnos.find(a=>a.id===id); openAlumno(x); }
      else if(btn.dataset.del){ if(confirm('¿Eliminar alumno?')) delAlumno(id); }
    });

    $('#search').addEventListener('input', ()=>drawTable());
    $('#filtroCurso').addEventListener('change', ()=>drawTable());
    $('#filtroSeccion').addEventListener('change', ()=>drawTable());
    $('#filtroCiclo').addEventListener('change', ()=>drawTable());

    $('#importCsvBtn').addEventListener('click', ()=>$('#importCsv').click());
    $('#importCsv').addEventListener('change', (e)=>{ const f=e.target.files?.[0]; if(!f) return; const reader=new FileReader(); reader.onload=()=>{ try{ const nuevos=parseCSV(String(reader.result)); state.alumnos.push(...nuevos); render(); alert('Importados: '+nuevos.length); }catch(err){ alert('Error CSV: '+err.message); } }; reader.readAsText(f); e.target.value=''; });

    $('#exportCsvBtn').addEventListener('click', exportCSV);

    $('#publicarActasBtn').addEventListener('click', ()=>{
      const noPublicadas = state.alumnos.filter(x=>!x.acta);
      if(!noPublicadas.length) return alert('No hay actas pendientes.');
      if(confirm('¿Marcar todas las actas como publicadas?')){
        state.alumnos.forEach(x=>x.acta=true); render(); alert('Actas marcadas como publicadas.');
      }
    });

    $('#actasPend').addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-publicar]'); if(!btn) return;
      const [curso, , seccion, , ciclo] = btn.dataset.publicar.split(' ');
      state.alumnos.filter(x=>x.curso===curso && x.seccion===seccion && x.ciclo===ciclo).forEach(x=>x.acta=true);
      render(); alert('Acta publicada para '+btn.dataset.publicar);
    });

    // Bulk actions
    $('#bulkSeccionBtn').addEventListener('click', ()=>openBulk('Mover a sección', '<label class="text-sm">Nueva sección<input id="bulkSeccion" class="mt-1 w-full px-3 py-2 border rounded-lg" placeholder="Ej: B"/></label>', ()=>{
      const val = $('#bulkSeccion').value.trim(); if(!val) return;
      selectedIds().forEach(id=>{ const x=state.alumnos.find(a=>a.id===id); if(x) x.seccion=val; });
      render();
    }));

    $('#bulkCursoBtn').addEventListener('click', ()=>openBulk('Cambiar curso', '<label class="text-sm">Nuevo curso<input id="bulkCurso" class="mt-1 w-full px-3 py-2 border rounded-lg" placeholder="Ej: Algoritmos"/></label>', ()=>{
      const val = $('#bulkCurso').value.trim(); if(!val) return;
      selectedIds().forEach(id=>{ const x=state.alumnos.find(a=>a.id===id); if(x) x.curso=val; });
      render();
    }));

    function openBulk(titulo, html, onApply){
      $('#bulkTitulo').textContent = titulo;
      $('#bulkContenido').innerHTML = html;
      $('#bulkModal').showModal();
      $('#bulkGuardar').onclick = (ev)=>{ ev?.preventDefault(); onApply(); $('#bulkModal').close(); };
    }

    $('#chkAll').addEventListener('change', (e)=>{
      $$('#tbodyAlumnos input[type="checkbox"]').forEach(ch=>ch.checked=e.target.checked);
    });

    function selectedIds(){ return $$('#tbodyAlumnos input[type="checkbox"]:checked').map(x=>x.dataset.chk); }

    // Tema
    $('#temaBtn').addEventListener('click', ()=>{
      document.documentElement.classList.toggle('dark');
      document.body.classList.toggle('bg-slate-900');
      document.body.classList.toggle('text-slate-100');
    });

    // Ordenamiento simple
    let sortKey='codigo'; let sortAsc=true;
    $$('th button[data-sort]').forEach(btn=>btn.addEventListener('click',()=>{
      const key = btn.dataset.sort;
      sortAsc = key===sortKey? !sortAsc : true; sortKey=key;
      state.alumnos.sort((a,b)=>{ if(a[key]<b[key]) return sortAsc?-1:1; if(a[key]>b[key]) return sortAsc?1:-1; return 0; });
      render();
    }));

    // Restablecer datos demo
    const resetBtn = document.getElementById('resetDemoBtn');
    if (resetBtn) {
      resetBtn.addEventListener('click', ()=>{
        if(confirm('¿Restablecer a alumnos de demostración? Se perderán cambios no guardados.')){
          state.alumnos = JSON.parse(JSON.stringify(demoAlumnos));
          save();
          render();
        }
      });
    }

    // Poblar 20 alumnos con notas altas
    const seed20Btn = document.getElementById('seed20Btn');
    if (seed20Btn) {
      seed20Btn.addEventListener('click', ()=>{
        if(confirm('Esto reemplazará la lista actual por 20 alumnos demo con notas altas. ¿Continuar?')){
          const cursos = [['Programación I','A'],['Programación I','B'],['Base de Datos I','A'],['Álgebra Lineal','B'],['Física I','A'],['Comunicación','C']];
          const nombres = ['Andrea','Juan','Lucía','Carlos','María','Pedro','Ana','Diego','Rosa','Mario','Jimena','Bruno','Valeria','Sergio','Paula','Hernán','Camila','Álvaro','Ximena','Raúl'];
          const apes = ['Ramos','Pérez','Gómez','Díaz','Torres','Salazar','Castillo','Rojas','Medina','López','Vega','Reyes','Campos','Flores','García','Navarro','Cruz','Bustamante','Soto','Romero'];
          const out=[]; let i=1;
          const rnd = ()=>18 + Math.floor(Math.random()*3); // 18–20
          while(out.length<20){
            const [curso,seccion] = cursos[Math.floor(Math.random()*cursos.length)];
            const nom = `${nombres[out.length % nombres.length]} ${apes[out.length % apes.length]}`;
            const codigo = 'U2025' + String(1000+i).padStart(4,'0');
            out.push(a(codigo, nom, curso, seccion, '2025-2', rnd(), rnd(), rnd(), rnd()));
            i++;
          }
          state.alumnos = out; save(); render();
        }
      });
    }

    // Init
    load();
    render();
  </script>
</body>
</html>
